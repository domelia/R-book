<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>R в социологических исследованиях - 12&nbsp; Регрессионный анализ в R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./PCA_CA.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/iconify-1.0.8/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Поиск не дал результатов",
    "search-matching-documents-text": "Результаты поиска",
    "search-copy-link-title": "Скопировать ссылку",
    "search-hide-matches-text": "Скрыть дополнительные результаты",
    "search-more-match-text": "дополнительный результат в этом документе",
    "search-more-matches-text": "дополнительных результата(-ов) в этом документе",
    "search-clear-button-title": "Очистить",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Отменить",
    "search-submit-button-title": "Найти",
    "search-label": "Поиск"
  }
}</script>
<script async="" src="https://hypothes.is/embed.js"></script>
<script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="include/webex.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Переключить боковую панель навигации" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Regression.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Регрессионный анализ в R</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Переключить боковую панель навигации" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R в социологических исследованиях</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/domelia/R-book/" title="Исходный код" class="quarto-navigation-tool px-1" aria-label="Исходный код"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Поиск"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">В качестве предисловия…</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./About-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Основные сведения об R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Install-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Установка и начало работы с R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Data-types-and-structures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Типы и структуры данных</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Intro-to-RMarkdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Основы работы с R Markdown</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Основы функционального программирования</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ImportExport.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Импорт и экспорт данных</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./TidyverseTransformations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Tidyverse и трансформация данных</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Base_ggplot2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Основы визуализации в ggplot2</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ExploratoryDataAnalysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Разведочный анализ данных в R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Statistical-Inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Статистический вывод и тестирование исследовательских гипотез</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./PCA_CA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Основы многомерного анализа: снижение размерности</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Regression.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Регрессионный анализ в R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Список источников</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Содержание</h2>
   
  <ul>
  <li><a href="#основы-линейной-регрессии" id="toc-основы-линейной-регрессии" class="nav-link active" data-scroll-target="#основы-линейной-регрессии"><span class="header-section-number">12.1</span> Основы линейной регрессии</a>
  <ul class="collapse">
  <li><a href="#загрузка-данных" id="toc-загрузка-данных" class="nav-link" data-scroll-target="#загрузка-данных"><span class="header-section-number">12.1.1</span> Загрузка данных</a></li>
  <li><a href="#предварительная-визуализация-данных" id="toc-предварительная-визуализация-данных" class="nav-link" data-scroll-target="#предварительная-визуализация-данных"><span class="header-section-number">12.1.2</span> Предварительная визуализация данных</a></li>
  <li><a href="#проставя-линейная-регрессия-и-функция-lm" id="toc-проставя-линейная-регрессия-и-функция-lm" class="nav-link" data-scroll-target="#проставя-линейная-регрессия-и-функция-lm"><span class="header-section-number">12.1.3</span> Проставя линейная регрессия и функция lm()</a></li>
  <li><a href="#множественная-регрессия" id="toc-множественная-регрессия" class="nav-link" data-scroll-target="#множественная-регрессия"><span class="header-section-number">12.1.4</span> Множественная регрессия</a></li>
  <li><a href="#линейная-регрессия-с-категориальными-предикторами" id="toc-линейная-регрессия-с-категориальными-предикторами" class="nav-link" data-scroll-target="#линейная-регрессия-с-категориальными-предикторами"><span class="header-section-number">12.1.5</span> Линейная регрессия с категориальными предикторами</a></li>
  </ul></li>
  <li><a href="#логистическая-регрессия" id="toc-логистическая-регрессия" class="nav-link" data-scroll-target="#логистическая-регрессия"><span class="header-section-number">12.2</span> Логистическая регрессия</a></li>
  <li><a href="#мультиномиальная-логистическая-регрессия" id="toc-мультиномиальная-логистическая-регрессия" class="nav-link" data-scroll-target="#мультиномиальная-логистическая-регрессия"><span class="header-section-number">12.3</span> Мультиномиальная логистическая регрессия</a></li>
  <li><a href="#непараметрическая-регрессия.-метод-k-ближайших-соседей" id="toc-непараметрическая-регрессия.-метод-k-ближайших-соседей" class="nav-link" data-scroll-target="#непараметрическая-регрессия.-метод-k-ближайших-соседей"><span class="header-section-number">12.4</span> Непараметрическая регрессия. Метод k-ближайших соседей</a>
  <ul class="collapse">
  <li><a href="#knn-в-r" id="toc-knn-в-r" class="nav-link" data-scroll-target="#knn-в-r"><span class="header-section-number">12.4.1</span> KNN в <code>R</code></a></li>
  <li><a href="#выбор-параметра-k" id="toc-выбор-параметра-k" class="nav-link" data-scroll-target="#выбор-параметра-k"><span class="header-section-number">12.4.2</span> Выбор параметра <span class="math inline">\(k\)</span></a></li>
  <li><a href="#сравнение-с-линейной-регрессией" id="toc-сравнение-с-линейной-регрессией" class="nav-link" data-scroll-target="#сравнение-с-линейной-регрессией"><span class="header-section-number">12.4.3</span> Сравнение с линейной регрессией</a></li>
  </ul></li>
  <li><a href="#самостоятельная-работа" id="toc-самостоятельная-работа" class="nav-link" data-scroll-target="#самостоятельная-работа"><span class="header-section-number">12.5</span> Самостоятельная работа</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/domelia/R-book/edit/main/Regression.qmd" class="toc-action"><i class="bi bi-github"></i>Редактировать страницу</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Регрессионный анализ в R</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="основы-линейной-регрессии" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="основы-линейной-регрессии"><span class="header-section-number">12.1</span> Основы линейной регрессии</h2>
<p>На предыдущих занятиях мы изучили основные типы и структуры данных, овладели основами создания простых функций на R, научились импортировать и экспортировать данные в разных форматах. Мы уже умеем проводить различные трансформации данных, визуализировать данные разного типа и проводить одномерный и двумерный анализ на категориальных данных. Мы даже справились со сложной задачей анализа данных с помощью метода главных компонент и анализа соответствий.</p>
<p>Мы продолжаем изучать многомерные методы, и следующий на очереди - регрессионный анализ и его отдельные разновидности.</p>
<p>В обобщенном виде уравнение регрессионного анализа может быть представлено как:</p>
<p><span class="math display">\[Y=X\beta+\epsilon,\]</span></p>
<p>где <span class="math inline">\(Y\)</span> - вектор значений зависимой переменной, <span class="math inline">\(X\)</span> - матрица значений независимых переменных (предикторов), <span class="math inline">\(\beta\)</span> - вектор коэффициентов регрессии, используемых для подгонки к известным значениям зависимой переменной, <span class="math inline">\(\epsilon\)</span> - ошибки модели (остатки, разница между реальными и предсказанными значениями).</p>
<p>Преимуществами и причинами популярности регрессионного анализа являются следующие:</p>
<ul>
<li>регрессионные модели могут включать множество предикторов одновременно, что позволяет оценивать вклад каждого при условии контроля над остальными параметрами;</li>
<li>существует большое количество разновидностей регрессионного анализа, могут использоваться различные типы предикторов и зависимых переменных;</li>
<li>довольно легко интерпретировать результаты;</li>
<li>достаточно просты в применении и не слишком сложны с математической точки зрения.</li>
</ul>
<p>Чаще всего используются следующие виды регрессионного анализа:</p>
<ul>
<li>линейная регрессия (зависимая переменная числовая)</li>
<li>логистическая регрессия (зависимая переменная бинарная)</li>
<li>порядковая регрессия (зависимая переменная - упорядоченная факторная)</li>
<li>мультиномиальная регрессия (зависимая переменная категориальная)</li>
</ul>
<section id="загрузка-данных" class="level3" data-number="12.1.1">
<h3 data-number="12.1.1" class="anchored" data-anchor-id="загрузка-данных"><span class="header-section-number">12.1.1</span> Загрузка данных</h3>
<p>В качестве практического примера мы будем использовать учебный набор данных о взаимосвязи между объемами продаж и затратами на рекламу. Это небольшой набор, который поможет понять основные идеи метода и его различные реализации.</p>
<p>Как всегда, мы начинаем с загрузки данных. Данные будут доступны в приложении к занятию.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>Advertising <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="st">"Advertising.csv"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>После загрузки данных в R, первым делом нужно посмотреть сами данные, их структуру. Поскольку мы использовали функцию <code>read_csv()</code>, данные были загружены в формате tibble (tbl_df). Это практически датафрейм, вернее его усовершенствованная версия, в которой данные обрабатываются быстрее, и не происходит некоторых неприятных трансформаций (например, не меняются типы и имена данных).</p>
<p>Мы видим, что у нас всего 200 наблюдений и 4 переменных типа <code>double</code> (числовой формат, в котором происходит более точное округление десятичных знаков до 16 знаков после запятой - с 64-битной, то есть двойной точностью).</p>
<p>В нашем наборе переменная <strong>Sales</strong> (Продажи) будет являться зависимой переменной, и мы будем пытаться выявить взаимосвязи между продажами и тремя другими - независимыми переменными: TV, Radio, и Newspaper, обозначающими, соответственно, затраты на рекламу на телевидении, радио и в газетах.</p>
</section>
<section id="предварительная-визуализация-данных" class="level3" data-number="12.1.2">
<h3 data-number="12.1.2" class="anchored" data-anchor-id="предварительная-визуализация-данных"><span class="header-section-number">12.1.2</span> Предварительная визуализация данных</h3>
<p>После рассмотрения структуры данных, следующий шаг - это визуализация. Поскольку у нас только количественные (не категориальные) переменные, лучший способ их представить - это диаграммы рассеяния, которые мы можем сделать для каждого индивидуального предиктора.</p>
<p>Например, для рекламы на телевидении</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Sales <span class="sc">~</span> TV, <span class="at">data =</span> Advertising, <span class="at">col =</span> <span class="st">"dodgerblue"</span>, <span class="at">pch =</span> <span class="dv">20</span>, <span class="at">cex =</span> <span class="fl">1.5</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Продажи vs Реклама на телевидении"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Regression_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Самостоятельная работа</strong>: сделайте аналогичные графики для других переменных.</p>
<p>Чтобы сделать все графики сразу, можно воспользоваться функцией `pairs().</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(Advertising)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Regression_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Часто нам интересно посмотреть взаимосвязи только между зависимой переменной и предиктором, а функция <code>pairs()</code> выдает много лишнего.</p>
<p>Функция <code>featurePlot()</code> из библиотеки <code>caret</code> <a href="https://topepo.github.io/caret/">(Classification And REgression Training)</a>, подходит для этой цели гораздо лучше.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">featurePlot</span>(<span class="at">x =</span> Advertising[ , <span class="fu">c</span>(<span class="st">"TV"</span>, <span class="st">"Radio"</span>, <span class="st">"Newspaper"</span>)], <span class="at">y =</span> Advertising<span class="sc">$</span>Sales)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Regression_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Мы видим, что есть явный рост продаж по мере увеличения рекламы на радио и телевидении, тогда как связь с рекламой в газетах не так очевидна.</p>
</section>
<section id="проставя-линейная-регрессия-и-функция-lm" class="level3" data-number="12.1.3">
<h3 data-number="12.1.3" class="anchored" data-anchor-id="проставя-линейная-регрессия-и-функция-lm"><span class="header-section-number">12.1.3</span> Проставя линейная регрессия и функция lm()</h3>
<p>Давайте построим простую линейную модель для продаж, в которой в качестве предиктора будут выступать затраты на телевизионную рекламу.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mod_1 <span class="ot">=</span> <span class="fu">lm</span>(Sales <span class="sc">~</span> TV, <span class="at">data =</span> Advertising)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="общие-результаты-и-тестирование-гипотез" class="level4" data-number="12.1.3.1">
<h4 data-number="12.1.3.1" class="anchored" data-anchor-id="общие-результаты-и-тестирование-гипотез"><span class="header-section-number">12.1.3.1</span> Общие результаты и тестирование гипотез</h4>
<p>Функция <code>summary()</code> позволяет вывести на экран информацию о модели, полученную с помощью функции <code>lm()</code>, которая может быть полезной для тестирования гипотез, касающихся предикторов и оценки значимости регрессионных коэффициентов.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_1)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Sales ~ TV, data = Advertising)

Residuals:
    Min      1Q  Median      3Q     Max 
-8.3860 -1.9545 -0.1913  2.0671  7.2124 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 7.032594   0.457843   15.36   &lt;2e-16 ***
TV          0.047537   0.002691   17.67   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3.259 on 198 degrees of freedom
Multiple R-squared:  0.6119,    Adjusted R-squared:  0.6099 
F-statistic: 312.1 on 1 and 198 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Давайте разбираться!</p>
<p>Вывод начинается с повторения регрессионного уравнения под заголовком <code>Call</code>: <code>lm(formula = Sales ~ TV, data = Advertising)</code>.</p>
<p>Затем в модели приводится распределение остатков. Остатки должны иметь нормальное распределение с абсолютными значениями минимума и максимума, также как и квартилями очень близкими друг к другу, что предполагает их примерно одинаковое расстояние от центра распределения.</p>
<p>В нашем случае это правило выполняется.</p>
<p>Следующая часть вывода содержит таблицу с коэффициентами.</p>
<p>Чтобы понять, что они означают и каким образом получаются, приведем формулу регрессии, но для случая с одной переменной:</p>
<p><span class="math display">\[y_i=\alpha+\beta x_i+\varepsilon_i,\]</span></p>
<p>где <span class="math inline">\(y\)</span> - зависимая переменная, <span class="math inline">\(i\)</span> - единица анализа, <span class="math inline">\(\alpha\)</span> - интерцепт (константа), <span class="math inline">\(\beta\)</span> - коэффициент регрессии, <span class="math inline">\(x\)</span> - независимая переменная и <span class="math inline">\(\varepsilon\)</span> - ошибка.</p>
<p>Когда мы работаем с выборочными данными, формула изменяется, так как вместо истинных значений у нас будут оценки:</p>
<p><span class="math display">\[\hat{y}=\hat{\alpha}+\hat{\beta}x\]</span></p>
<p>Оценка для интерцепта (<span class="math inline">\(\alpha\)</span>) - значение <span class="math inline">\(y\)</span> когда <span class="math inline">\(x = 0\)</span>. В геометрическом смысле это точка пересечения регрессионной прямой с осью <span class="math inline">\(OY\)</span>. Иногда интерцепт может иметь смысл и подлежит интерпретации, но часто он может принимать несуществующие значения, выходящие за рамки возможных значений переменных, не описывается и не интерпретируется (допустим, мы пытаемся выявить зависимость веса от роста, получается, что интерцепт нам покажет, чем равен вес, когда рост равен нулю, что не имеет смысла).</p>
<p>В нашем примере интерцепт - это среднее значение продаж при нулевых затратах на рекламу.</p>
<p>Далее следуют коэффициенты для предикторов. Для каждого предиктора коэффициент обозначает ожидаемое изменение в зависимой переменной при изменении предиктора на одну единицу.</p>
<p>Геометрический смысл beta-beкоэффициента: это угол наклона регрессионной прямой:</p>
<p><img src="https://assets.coursehero.com/study-guides/lumen/images/pima-concepts-statistics/linear-regression-3-of-4/m3_examining_relationships_topic_3_2_fit_line_algebra11.gif" class="img-fluid"></p>
<p>Чтобы найти коэффициенты <span class="math inline">\(\alpha\)</span> и <span class="math inline">\(\beta\)</span> нам нужно понять, как они вычисляются. Начнем с коэффициентов <span class="math inline">\(\beta\)</span>:</p>
<p><span class="math display">\[\hat{\beta}=\frac{cov(x,y)}{var(x)}\]</span></p>
<p>Чтобы узнать коэффициент <span class="math inline">\(\beta\)</span> для рекламы на телевидении, нам необходимо найти ковариацию между рекламой и продажами и дисперсию затрат на рекламу:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>cov_x_y<span class="ot">&lt;-</span><span class="fu">cov</span>(Advertising<span class="sc">$</span>TV, Advertising<span class="sc">$</span>Sales)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>var_x<span class="ot">&lt;-</span><span class="fu">var</span>(Advertising<span class="sc">$</span>TV)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>beta_x<span class="ot">&lt;-</span>cov_x_y<span class="sc">/</span>var_x</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>beta_x</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.04753664</code></pre>
</div>
</div>
<p>Коэффициент показывает, на сколько увеличатся продажи, при увеличении затрат на рекламу на единицу.</p>
<p>Посчитав коэффициент <span class="math inline">\(\beta\)</span>, мы можем перейти к <span class="math inline">\(\alpha\)</span>:</p>
<p><span class="math display">\[\hat{\alpha}=\bar{y} - \hat{\beta}\bar{x}\]</span></p>
<p>Для того, чтобы вычислить его вручную, нам необходимо знать средние значения <span class="math inline">\(\bar{y}\)</span> и <span class="math inline">\(\bar{x}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>y_bar<span class="ot">&lt;-</span><span class="fu">mean</span>(Advertising<span class="sc">$</span>Sales)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>x_bar<span class="ot">&lt;-</span><span class="fu">mean</span>(Advertising<span class="sc">$</span>TV)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>intercept<span class="ot">&lt;-</span>y_bar<span class="sc">-</span>beta_x<span class="sc">*</span>x_bar</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>intercept</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7.032594</code></pre>
</div>
</div>
<p>Все сходится!</p>
<p>Теперь мы можем посчитать предсказанные значения по продажам на основе нашей модели:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>yhat <span class="ot">&lt;-</span> intercept <span class="sc">+</span> beta_x <span class="sc">*</span> Advertising<span class="sc">$</span>TV</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(yhat) </span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17.970775  9.147974  7.850224 14.234395 15.627218  7.446162</code></pre>
</div>
</div>
<p>Когда мы проводим регрессионный анализ, один из главных вопросов, которые мы себе задаем - можно ли на основе знаний о переменной <span class="math inline">\(x\)</span> понять, как ведет себя <span class="math inline">\(y\)</span>. Говоря формальным языком, мы исследуем эту взаимосвязь, оценивая остаточные значения, ассоциированные с коэффициентами <span class="math inline">\(\alpha\)</span> и <span class="math inline">\(\beta\)</span>, на основе тестирования гипотез о том, отличаются ли данные коэффициенты от нуля.</p>
<p>Например:</p>
<ul>
<li><span class="math inline">\(H_0: \beta=0\)</span></li>
<li><span class="math inline">\(H_1: \beta \neq 0\)</span></li>
</ul>
<p>Иными словами, если коэффициент <span class="math inline">\(\beta\)</span> равен нулю, то переменная <span class="math inline">\(x\)</span> никак не объясняет <span class="math inline">\(y\)</span>, так как <span class="math inline">\(0 \times x=0\)</span>.</p>
<p>Поскольку мы основываемся на допущении о том, что остатки имеют нормальное распределение, это нам позволяет рассчитать t-статистику для коэффициентов и проверить их статистическую значимость.</p>
<p>Хотя R все делает автоматически, давайте разберемся, как это происходит.</p>
<p>Посчитаем разницу между реальными и предсказанными значениями по продажам:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> Advertising<span class="sc">$</span>Sales <span class="sc">-</span> yhat</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  4.1292255  1.2520260  1.4497762  4.2656054 -2.7272181 -0.2461623</code></pre>
</div>
</div>
<p>Далее мы должны посчитать разброс наблюдений вокруг регрессионной прямой, которую мы только что воспроизвели, а также стандартную ошибку остатков, которая используется для оценки ошибок коэффициентов и их статистической значимости.</p>
<p>Чтобы найти стандартную ошибку остатков, нам требуется:</p>
<ul>
<li>найти сумму квадратов отклонений остатков (<span class="math inline">\(RSS\)</span>)</li>
<li>найти количество степеней свободы (<span class="math inline">\(df=N-2\)</span>)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>res.sqr <span class="ot">&lt;-</span> res<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>RSS <span class="ot">&lt;-</span> <span class="fu">sum</span>(res.sqr, <span class="at">na.rm=</span>T)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">length</span>(Advertising<span class="sc">$</span>Sales) <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 198</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>RSE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(RSS <span class="sc">/</span> df)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>RSE</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.258656</code></pre>
</div>
</div>
<p>Собственно говоря, это мы и видим в выводе: <code>Residual standard error: 3.259 on 198 degrees of freedom</code>.</p>
<p>Зная стандартную ошибку остатков, мы можем вычислить стандартные ошибки для наших коэффициентов. Для этого, мы должны сначала вычислить сумму квадратов отклонений по независимой переменной (затраты на рекламу ТВ):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>TSSx <span class="ot">&lt;-</span> <span class="fu">sum</span>((Advertising<span class="sc">$</span>TV <span class="sc">-</span> x_bar)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>TSSx</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1466819</code></pre>
</div>
</div>
<p>Чтобы найти стандартную ошибку коэффициента <span class="math inline">\(\beta\)</span>, нужно стандартную ошибку остатков разделить на квадратный корень из суммы квадратов отклонений по переменной <span class="math inline">\(x\)</span>:</p>
<p><span class="math display">\[SE_{\beta}=\frac{RSE}{\sqrt{TSS_x}}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>SEB <span class="ot">&lt;-</span> RSE <span class="sc">/</span> <span class="fu">sqrt</span>(TSSx)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>SEB</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.002690607</code></pre>
</div>
</div>
<p>Для интерцепта алгоритм несколько отличается:</p>
<p><span class="math display">\[SE_{\alpha}=RSE*\sqrt{\frac{1}{N}+\frac{\bar{x^2}}{TSS_x}}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>SEA <span class="ot">&lt;-</span> RSE <span class="sc">*</span> <span class="fu">sqrt</span>((<span class="dv">1</span> <span class="sc">/</span> <span class="dv">200</span>)<span class="sc">+</span>(x_bar<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> TSSx))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>SEA</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4578429</code></pre>
</div>
</div>
<p>Зная стандартные ошибки, мы можем теперь посчитать соответствующие t-статистики, чтобы оценить, отличаются ли наши коэффициенты от нуля. Для этого нужно значения коэффициентов разделить на их стандартные ошибки.</p>
<p>Для коэффициента по переменной телевизионной рекламы:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>t.B <span class="ot">&lt;-</span> beta_x <span class="sc">/</span> SEB</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>t.B</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17.66763</code></pre>
</div>
</div>
<p>Для интерцепта:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>t.A <span class="ot">&lt;-</span> intercept <span class="sc">/</span> SEA</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>t.A</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 15.36028</code></pre>
</div>
</div>
<p>Эти значения измеряются в стандартных отклонениях и показывают, насколько далеко наши коэффициенты находятся от нуля. Значения 17,6 и 15,4 очень большие, следовательно, наши коэффициенты статистически значимы, что и подтверждают соответствующие p-значения из вывода: <code>15.36   &lt;2e-16 ***</code> и <code>17.67   &lt;2e-16 ***</code>.</p>
</section>
<section id="показатели-качества-модели" class="level4" data-number="12.1.3.2">
<h4 data-number="12.1.3.2" class="anchored" data-anchor-id="показатели-качества-модели"><span class="header-section-number">12.1.3.2</span> Показатели качества модели</h4>
<p>Какие еще важные показатели мы должны принять во внимание, когда мы анализируем результаты регрессионного анализа?</p>
<p>Обратимся к оставшейся части вывода.</p>
<p>Основной мерой, показывающей, насколько хорошо регрессионная модель объясняет данные, является коэффициент детерминации - <span class="math inline">\(R^2\)</span>. Для того, чтобы найти <span class="math inline">\(R^2\)</span>, нужны следующие промежуточные вычисления о некоторых компонентах дисперсии зависимой переменной:</p>
<ul>
<li>сумме квадратов остатков (RSS)</li>
<li>общей сумме квадратов отклонений от среднего (TSS)</li>
<li>сумме квадратов отклонений, объясненной моделью (ESS)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>TSS <span class="ot">&lt;-</span> <span class="fu">sum</span>((Advertising<span class="sc">$</span>Sales <span class="sc">-</span> y_bar)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>TSS</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5417.149</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>ESS <span class="ot">&lt;-</span> TSS <span class="sc">-</span> RSS</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>ESS</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3314.618</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>r.sqr <span class="ot">&lt;-</span> ESS <span class="sc">/</span> TSS</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>r.sqr</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6118751</code></pre>
</div>
</div>
<p>Таким образом, 61,2% дисперсии зависимой переменной объясняется регрессионной моделью.</p>
<p>Несмотря на то, что показатель <span class="math inline">\(R^2\)</span> является довольно информативным, у него есть один существенный недостаток: он имеет свойство неоправданно возрастать, при включении дополнительных переменных в анализ, даже если они не оказывают существенного влияния на зависимую переменную. Иными словами, чем более комплексной будет модель, тем выше будет <span class="math inline">\(R^2\)</span>, что не очень хорошо.</p>
<p>Поэтому вместо обычного <span class="math inline">\(R^2\)</span> в качестве более точной оценки качества модели используется скорректированный показатель - <code>adjusted $R^2$</code>. Проблему множественных предикторов этот показатель решает, путем внесения «наказаний» (пенальти) за включение в модель дополнительных переменных. Чтобы найти скорректированный <span class="math inline">\(R^2\)</span> используется формула:</p>
<p><span class="math display">\[1-\frac{(1-R^{2})(n-1)}{n-k-1},\]</span></p>
<p>где <span class="math inline">\(k\)</span> - количество предикторов в модели, не считая интерцепта (A).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>r.sqr.adj<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">-</span>(((<span class="dv">1</span> <span class="sc">-</span> r.sqr) <span class="sc">*</span> (<span class="dv">200</span> <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">/</span> (<span class="dv">200</span> <span class="sc">-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>r.sqr.adj</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6099148</code></pre>
</div>
</div>
<p>Поскольку у в модели один предиктор, значение уменьшилось незначительно.</p>
<p>У нас остался нерассмотренным только один показатель из вывода - F-статистика. F-критерий является «глобальным» тестом, показывающим, насколько лучше наша модель базовой модели - такой, в которую включен только один интерцепт.</p>
<p>Еще одна интерпретация: этот тест показывает, что в нашей модели есть хотя бы один значимый предиктор.</p>
<p>В нашем выводе <code>F-statistic: 312.1 on 1 and 198 DF,  p-value: &lt; 2.2e-16</code>, что указывает на то, что модель с предиктором существенно лучше базовой модели объясняет зависимую переменную.</p>
</section>
<section id="сравнение-нескольких-моделей" class="level4" data-number="12.1.3.3">
<h4 data-number="12.1.3.3" class="anchored" data-anchor-id="сравнение-нескольких-моделей"><span class="header-section-number">12.1.3.3</span> Сравнение нескольких моделей</h4>
<p>Допустим, мы хотим создать несколько двумерных моделей и сравнить их. Это возможно с помощью функции <code>mtable()</code> из пакета <code>memisc</code> (Management of Survey Data and Presentation of Analysis Results - управление данными исследований и презентация результатов анализа). Для демонстрации создадим три модели, иллюстрирующие взаимосвязь между продажами и каждым типом рекламы.</p>
<p>Первая модель у нас уже есть, создадим две других:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>mod_2 <span class="ot">=</span> <span class="fu">lm</span>(Sales <span class="sc">~</span> Radio, <span class="at">data =</span> Advertising)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>mod_3 <span class="ot">=</span> <span class="fu">lm</span>(Sales <span class="sc">~</span> Newspaper, <span class="at">data =</span> Advertising)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Благодаря функции ‘mtable()’ мы можем создать таблицу, в которой сведем всю важную информацию по всем трем моделям:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(memisc)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>mtable<span class="ot">&lt;-</span><span class="fu">mtable</span>(mod_1, mod_2, mod_3)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>mtable</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Calls:
mod_1: lm(formula = Sales ~ TV, data = Advertising)
mod_2: lm(formula = Sales ~ Radio, data = Advertising)
mod_3: lm(formula = Sales ~ Newspaper, data = Advertising)

===================================================
                 mod_1       mod_2       mod_3     
---------------------------------------------------
  (Intercept)    7.033***    9.312***   12.351***  
                (0.458)     (0.563)     (0.621)    
  TV             0.048***                          
                (0.003)                            
  Radio                      0.202***              
                            (0.020)                
  Newspaper                              0.055**   
                                        (0.017)    
---------------------------------------------------
  R-squared      0.612       0.332       0.052     
  N            200         200         200         
===================================================
  Significance: *** = p &lt; 0.001; ** = p &lt; 0.01;   
                * = p &lt; 0.05  </code></pre>
</div>
</div>
<p>Видим, что хотя во всех моделях интерцепты и коэффициенты предикторов являются значимыми, показатель <span class="math inline">\(R^2\)</span> максимально высок в модели, где в качестве объясняющей переменной используется показатель затрат на рекламу на телевидении.</p>
</section>
</section>
<section id="множественная-регрессия" class="level3" data-number="12.1.4">
<h3 data-number="12.1.4" class="anchored" data-anchor-id="множественная-регрессия"><span class="header-section-number">12.1.4</span> Множественная регрессия</h3>
<p>Рассмотрим случай, когда количество предикторов больше одного, то есть наша модель является моделью уже не простой, а множественной регрессии.</p>
<p>Формула для нескольких предикторов приобретает вид:</p>
<p><span class="math display">\[\hat{y} = \hat{\beta_0} + \hat{\beta_1}x_1 + \hat{\beta_2}x_2 ...+... \hat{\beta_n}x_n\]</span></p>
<p>Синтаксис в R аналогичен тому, что мы использовали для двумерной регрессии. Создадим модель, в которую включим сразу все независимые переменные.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>mod_4 <span class="ot">=</span> <span class="fu">lm</span>(Sales <span class="sc">~</span> TV <span class="sc">+</span> Radio <span class="sc">+</span> Newspaper, <span class="at">data =</span> Advertising)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co">#mod_4 = lm(Sales ~ ., data = Advertising) можно использовать и такой синтаксис</span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Кроме функции <code>summary()</code> красивую таблицу с результатами можно создать с помощью функции <code>tab_model()</code> из библиотеки <code>sjPlot</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>sjPlot<span class="sc">::</span><span class="fu">tab_model</span>(mod_4)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" style="text-align: center; border-top: double; font-style: normal; font-weight: bold; padding: 0.2cm;">&nbsp;</td>
<td colspan="3" data-quarto-table-cell-role="th" style="text-align: center; border-top: double; font-style: normal; font-weight: bold; padding: 0.2cm;">Sales</td>
</tr>
<tr class="even">
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">Predictors</td>
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">Estimates</td>
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">CI</td>
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">p</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">(Intercept)</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">2.94</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">2.32&nbsp;–&nbsp;3.55</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"><strong>&lt;0.001</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">TV</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.05</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.04&nbsp;–&nbsp;0.05</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"><strong>&lt;0.001</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">Radio</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.19</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.17&nbsp;–&nbsp;0.21</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"><strong>&lt;0.001</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">Newspaper</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.00</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">-0.01&nbsp;–&nbsp;0.01</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.860</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm; border-top: 1px solid;">Observations</td>
<td colspan="3" style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm; border-top: 1px solid;">200</td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm;">R<sup>2</sup> / R<sup>2</sup> adjusted</td>
<td colspan="3" style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm;">0.897 / 0.896</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Результаты показывают, что значимыми являются только коэффициенты для радио- и телерекламы, тогда как реклама в газетах не является значимым фактором, определяющим продажи.</p>
<p>Скорректированный коэффициент детерминации (Adjusted R-squared), показывает, что эта модель гораздо лучше, чем любая модель с одним предиктором, и объясняет 89,6% дисперсии.</p>
<p>Дополнительно, в целях сравнения, давайте создадим более простую модель, без газет.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>mod_5 <span class="ot">=</span> <span class="fu">lm</span>(Sales <span class="sc">~</span> TV <span class="sc">+</span> Radio, <span class="at">data =</span> Advertising)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>sjPlot<span class="sc">::</span><span class="fu">tab_model</span>(mod_5)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th" style="text-align: center; border-top: double; font-style: normal; font-weight: bold; padding: 0.2cm;">&nbsp;</td>
<td colspan="3" data-quarto-table-cell-role="th" style="text-align: center; border-top: double; font-style: normal; font-weight: bold; padding: 0.2cm;">Sales</td>
</tr>
<tr class="even">
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">Predictors</td>
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">Estimates</td>
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">CI</td>
<td style="text-align: center; border-bottom: 1px solid; font-style: italic; font-weight: normal;">p</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">(Intercept)</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">2.92</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">2.34&nbsp;–&nbsp;3.50</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"><strong>&lt;0.001</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">TV</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.05</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.04&nbsp;–&nbsp;0.05</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"><strong>&lt;0.001</strong></td>
</tr>
<tr class="odd">
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">Radio</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.19</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;">0.17&nbsp;–&nbsp;0.20</td>
<td style="text-align: left; padding: 0.2cm; vertical-align: top;"><strong>&lt;0.001</strong></td>
</tr>
<tr class="even">
<td style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm; border-top: 1px solid;">Observations</td>
<td colspan="3" style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm; border-top: 1px solid;">200</td>
</tr>
<tr class="odd">
<td style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm;">R<sup>2</sup> / R<sup>2</sup> adjusted</td>
<td colspan="3" style="text-align: left; padding: 0.2cm; vertical-align: top; padding-top: 0.1cm; padding-bottom: 0.1cm;">0.897 / 0.896</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Как видим, коэффициент детерминации не изменился (что неудивительно, ведь у удаленной переменной коэффициент регрессии равнялся нулю).</p>
<section id="сравнение-моделей-с-помощью-дисперсионного-анализа" class="level4" data-number="12.1.4.1">
<h4 data-number="12.1.4.1" class="anchored" data-anchor-id="сравнение-моделей-с-помощью-дисперсионного-анализа"><span class="header-section-number">12.1.4.1</span> Сравнение моделей с помощью дисперсионного анализа</h4>
<p>Чтобы сравнить, какая модель работает лучше, можно применить функцию <code>anova()</code>, запускающую дисперсионный анализ. В нашем случае, мы будем сравнивать модель со всеми предикторами <strong>mod_1</strong> с сокращенной моделью <strong>mod_0</strong>. Наша задача будет заключаться в том, чтобы понять, какую роль играет переменная газетной рекламы в аддитивной модели.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(mod_4, mod_5)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Model 1: Sales ~ TV + Radio + Newspaper
Model 2: Sales ~ TV + Radio
  Res.Df    RSS Df Sum of Sq      F Pr(&gt;F)
1    196 556.83                           
2    197 556.91 -1 -0.088717 0.0312 0.8599</code></pre>
</div>
</div>
<p>Мы видим, что разница между моделями в одну степень свободы (1 параметр - как раз наша переменная о рекламе в газетах).</p>
<div class="alert alert-info" role="alert">
<p><strong>Число степеней свободы (df)</strong> − важный показатель регрессионного анализа, используемый в формулах метрик, показывающих качество модели:</p>
<ul>
<li>Res.Df - число степеней свободы, рассчитываемых для остатков (разности между предсказанными и реальными значениями).</li>
<li>Res.Df - количество наблюдений - количество оцениваемых параметров.</li>
<li>Model 1: Sales ~ TV + Radio</li>
<li>df= 197= 200-3 (2 предиктора + константа)</li>
<li>Model 2: Sales ~ TV + Radio + Newspaper</li>
<li>df= 196= 200-4 (2 предиктора + константа)</li>
</ul>
</div>
<p>Результаты дисперсионного анализа показывают, что качество модели не поменялось, и значит мы можем использовать более лаконичную (сокращенную) модель.</p>
</section>
<section id="предсказание-значений-зависимой-переменной-для-новых-данных" class="level4" data-number="12.1.4.2">
<h4 data-number="12.1.4.2" class="anchored" data-anchor-id="предсказание-значений-зависимой-переменной-для-новых-данных"><span class="header-section-number">12.1.4.2</span> Предсказание значений зависимой переменной для новых данных</h4>
<p>Обычно у регрессионного анализа две основные задачи - <strong>объяснение</strong> взаимосвязи между переменными и <strong>предсказание</strong> новых (неизвестных) значений зависимой переменной на основе модели. Для осуществления прогноза чаще всего используется функция <code>predict()</code>, обладающая большой гибкостью (может применяться с различными методами моделирования и типами данных).</p>
<p>Если эту функцию использовать к модели, созданной на основе функции <code>lm()</code>, то она будет рассчитывать предсказанные значения для каждого наблюдения.</p>
<p>Давайте посмотрим первые десять.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">predict</span>(mod_5), <span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        1         2         3         4         5         6         7         8 
20.555465 12.345362 12.337018 17.617116 13.223908 12.512084 11.718212 12.105516 
        9        10 
 3.709379 12.551697 </code></pre>
</div>
</div>
<p>Отметим, что эффект функции <code>predict()</code>будет зависеть от того, какие данные даются на входе. Наша модель относится к классу<code>lm</code>, поэтому <code>predict()</code> запускает функцию<code>predict.lm()</code> Если нам нужно что-то другое, можно посмотреть подробности с помощью <code>?predict.lm()</code>.</p>
<p>Мы также можем сгенерировать новые данные, и попробовать посчитать зависимую переменную на них.</p>
<p>Давайте создадим новый набор с идентичными именами переменных.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>new_obs <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">TV =</span> <span class="dv">150</span>, <span class="at">Radio =</span> <span class="dv">40</span>, <span class="at">Newspaper =</span> <span class="dv">1</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Теперь мы можем использовать <code>predict()</code>, чтобы посчитать оценки и доверительные интервалы для новых данных.</p>
<p>Если указать только модель и источник данный, <code>R</code> выдаст точечную оценку, то есть “предсказанное значение” <span class="math inline">\(\hat{y}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(mod_5, <span class="at">newdata =</span> new_obs)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1 
17.30409 </code></pre>
</div>
</div>
<p>Если указать дополнительно аргумент<code>interval</code> со значением <code>"confidence"</code>, <code>R</code> покажет также 95% доверительные интервалы для среднего значения по данному наблюдению.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(mod_1, <span class="at">newdata =</span> new_obs, <span class="at">interval =</span> <span class="st">"confidence"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       fit      lwr      upr
1 14.16309 13.70842 14.61776</code></pre>
</div>
</div>
<p>Кроме того, мы можем изменить уровень и выбрать не доверительные интервалы, а предсказательные интервалы (доверительные интервалы прогноза). В чем отличие?</p>
<p>Предсказательные интервалы показывают, в каком диапазоне значений будет находиться будущее наблюдение, тогда как доверительные интервалы показывают вероятный диапазон, в котором будет находится какой-либо статистический параметр, например, среднее в генеральной совокупности.</p>
<p>Поскольку предсказательные интервалы рассчитываются в ситуации большей неопределенности, то они обычно шире, чем доверительные интервалы.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(mod_1, <span class="at">newdata =</span> new_obs, <span class="at">interval =</span> <span class="st">"prediction"</span>, <span class="at">level =</span> <span class="fl">0.95</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       fit      lwr      upr
1 14.16309 7.720898 20.60528</code></pre>
</div>
</div>
</section>
<section id="диагностика-модели-и-оценка-влияния-наблюдений-на-результаты" class="level4" data-number="12.1.4.3">
<h4 data-number="12.1.4.3" class="anchored" data-anchor-id="диагностика-модели-и-оценка-влияния-наблюдений-на-результаты"><span class="header-section-number">12.1.4.3</span> Диагностика модели и оценка влияния наблюдений на результаты</h4>
<p>В <code>R</code> доступны несколько функций, позволяющих оценить, насколько полученная модель хорошо воспроизводит исходные данные, и как различные наблюдения вносят вклад в предсказательные способности этой модели:</p>
<ul>
<li><code>resid()</code> выдает остаток (разность между предсказанным и реальным значением)</li>
<li><code>hatvalues()</code> показывает <code>leverage</code> - отклонение в значениях по независимым переменным по каждому наблюдению. Данный показатель важен для понимания, как экстремальные значения по независимым переменным могут повлиять на результаты анализа.</li>
</ul>
<div class="{callout-info}">
<p>Что такое <code>hat</code> - значения? <code>hat</code> - <em>по-английски</em> «шляпа», а также диакритический знак «циркумфлекс» (<span class="math inline">\(\hat{ }\)</span>), с помощью которого обозначаются значения зависимой переменной, предсказанные с помощью регрессионной модели.</p>
<p>Эти предсказанные значения обозначаются как <span class="math inline">\(\hat{y}\)</span> и рассчитываются по формуле:</p>
<p><span class="math display">\[\hat{y}=Xb\]</span></p>
<p>Для коэффициентов линейной регрессии используется следующая формула:</p>
<p><span class="math display">\[b = (X^{'}X)^{-1}X^{'}y\]</span></p>
<p>Следовательно, мы можем переписать уравнение для предсказанных значений как:</p>
<p><span class="math display">\[\hat{y}=X(X^{'}X)^{-1}X^{'}y\]</span></p>
<p>Таким образом, предсказанные значения могут быть получены путем умножения <span class="math inline">\(n \times 1\)</span> вектора <span class="math inline">\(y\)</span>, содержащего наблюдаемые значения на <span class="math inline">\(n \times n\)</span> матрицы <span class="math inline">\(H\)</span>:</p>
<p><span class="math display">\[H=X(X^{'}X)^{-1}X^{'}\]</span></p>
<p>Или, более лаконично:</p>
<p><span class="math display">\[\hat{y}=Hy\]</span></p>
<p>Матрица <span class="math inline">\(H\)</span> часто называется <code>hat-matrix</code> - «матрица в шляпе», а ее диагональные значения как раз и являются значениями левериджа.</p>
</div>
<ul>
<li><code>rstudent()</code> стьюдентизированные остатки по каждому наблюдению (остаток в регрессионной модели деленный на ее скорректированную стандартную ошибку)</li>
<li><code>cooks.distance()</code> рассчитывает важность каждого наблюдения</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>ddf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">residuals=</span><span class="fu">residuals</span>(mod_1), <span class="at">rstandard=</span><span class="fu">rstandard</span>(mod_1), <span class="at">rstudent=</span><span class="fu">rstudent</span>(mod_1), <span class="at">leverage=</span><span class="fu">hatvalues</span>(mod_1), <span class="at">cookd=</span><span class="fu">cooks.distance</span>(mod_1))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Как мы можем это использовать?</p>
<p>Например, мы можем отобрать наблюдения, чьи стандартизированные остатки отклоняются более, чем на 2 стандартных отклонения в обе стороны:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(ddf, <span class="fu">abs</span>(rstandard) <span class="sc">&gt;</span> <span class="dv">2</span> <span class="sc">|</span> <span class="fu">abs</span>(rstudent) <span class="sc">&gt;</span> <span class="dv">2</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    residuals rstandard  rstudent    leverage      cookd
26  -7.529976 -2.327287 -2.353820 0.014151068 0.03887305
36  -8.051495 -2.494703 -2.528450 0.019069546 0.06049366
56   7.212369  2.220896  2.243400 0.006833355 0.01696830
59   6.746683  2.078480  2.096219 0.007771316 0.01691782
129  7.195085  2.217613  2.239999 0.008658707 0.02147689
132 -6.939311 -2.145129 -2.165011 0.014518008 0.03389496
148  6.806495  2.100649  2.119084 0.011303617 0.02522502
176  6.804511  2.105573  2.124165 0.016496285 0.03718098
179 -8.385982 -2.594894 -2.633499 0.016460901 0.05634703</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p><iconify-icon inline="" icon="arcticons:brain-it-on" style="font-size: 42px;"></iconify-icon> <strong>Задание</strong>: проанализируйте в таблице исходных данных наблюдения с указанными номерами. Какие выводы можно сделать?</p>
</blockquote>
<p>Второй важный момент: анализ показателей <code>leverage</code> и <code>Cook's distance</code>.</p>
<p>Замечательная вещь по поводу левериджа заключается в том, что его значения помогают выявить экстремальные значения <span class="math inline">\(x\)</span>, которые могут влиять на результаты регрессионного анализа. Каким образом? Мы должны понять, какое значение левериджа нужно признать большим, то есть соответствующим значениям <span class="math inline">\(x\)</span>, расположенным максимально далеко от средних значений по всем другим наблюдениям. Общим является правило, согласно которому, любое наблюдение, чье значение левериджа в три раза превышает среднее значение, является нетипичным / странным / достойным внимания:</p>
<p><span class="math display">\[\bar{h}=\frac{\sum_{i=1}^{n}h_{ii}}{n}=\frac{p}{n}\]</span></p>
<p>Иными словами, если:</p>
<p><span class="math display">\[h_{ii} &gt;3\left( \dfrac{p}{n}\right),\]</span></p>
<p>то мы должны обратить внимание на это наблюдение. Сумма всех значений левериджа равняется количеству параметров модели: 2 - три предиктора + интерцепт (константа).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>hatmax <span class="ot">=</span> <span class="dv">3</span><span class="sc">*</span><span class="dv">4</span><span class="sc">/</span><span class="dv">200</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(ddf, leverage<span class="sc">&gt;</span>hatmax)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] residuals rstandard rstudent  leverage  cookd    
&lt;0 строк&gt; (или 'row.names' нулевой длины)</code></pre>
</div>
</div>
<p>Что мы видим? Например, наблюдение 17 имеет самый большой леверидж, но очень маленькое влияние по расстоянию Кука, аналогичная ситуация наблюдается и с 102 и 166 наблюдениями (последнее, например, примечательно большими затратами на телерекламу при скромных продажах).</p>
<p>Мы можем отсортировать наблюдения по расстоянию Кука, чтобы понять, какие наблюдения являются наиболее влиятельными:</p>
<p><span class="math display">\[D_i=\frac{(y_i-\hat{y}_i)^2}{(k+1) \times MSE}\left[ \frac{h_{ii}}{(1-h_{ii})^2}\right],\]</span></p>
<p>где <span class="math inline">\(MSE\)</span> - среднеквадратическая ошибка регрессии, а <span class="math inline">\(h_{ii}\)</span> - значения левериджа.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(ddf, <span class="fu">desc</span>(cookd))[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,]</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    residuals rstandard  rstudent   leverage      cookd
36  -8.051495 -2.494703 -2.528450 0.01906955 0.06049366
179 -8.385982 -2.594894 -2.633499 0.01646090 0.05634703
26  -7.529976 -2.327287 -2.353820 0.01415107 0.03887305
176  6.804511  2.105573  2.124165 0.01649629 0.03718098
132 -6.939311 -2.145129 -2.165011 0.01451801 0.03389496
131 -5.465869 -1.694022 -1.702119 0.01960039 0.02868598</code></pre>
</div>
</div>
<p>Рекомендуется исключать из анализа наблюдения, расстояние Кука для которых превышает 1.</p>
<p>Аналогичную информацию можно получить с помощью специальных графиков:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mod_1)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Regression_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Что показывают графики?</p>
<p><strong>1. Residuals vs Fitted</strong> (Остатки vs предсказанные значения)</p>
<p>Этот график показывает, есть ли в остатках регресии какие-либо нелинейные паттерны. Такое может случиться, если между предикторными переменными и зависимой переменной имеются нелинейные взаимосвязи, соответственно если эта нелинейность возникает на графике, значит модель плохо воспроизводит эти отношения. Если мы видим, что остатки равномерно распределены вокруг линии предсказанных значений без каких-либо серьезных колебаний, это хороший знак, значит у нас в модели таких нелинейных взаимосвязей нет. На нашем графике есть еле заметный «прогиб», но четким паттерном его назвать вряд ли возможно.</p>
<p><strong>2. Normal Q-Q residuals</strong></p>
<p>Данный график показывает, что остатки нормально распределены (то есть маленьких остатков много и их среднее значение приближается к нулю, в больших остатков мало). У нас с нормальностью остатков практически все в порядке, если не считать постоянно выбивающееся наблюдение 131.</p>
<p><strong>3. Scale-Location</strong></p>
<p>Данный график позволяет протестировать допущение о гомогенности дисперсии остатков (гомоскедастичности). Если мы видим, что остатки распределены вдоль линии равномерно, и их форма не напоминает «фен», то все хорошо.</p>
<p><strong>4. Residuals vs Leverage</strong></p>
<p>Ну и, наконец, последний график визуализирует самые влиятельные наблюдения - одновременно через леверидж и расстояние Кука. Сомнительные наблюдения на всех графиках обозначены цифрами.</p>
<p>Библиотека <code>olsrr</code> (Tools for Building OLS Regression Models) также содержит несколько полезных функций, которые могут помочь в выявлении таких наблюдений.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(olsrr)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_plot_cooksd_bar</span>(mod_1)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Regression_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_plot_cooksd_chart</span>(mod_1)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Regression_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_plot_dfbetas</span>(mod_1)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Regression_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Что дальше? Мы выяснили, что некоторые наблюдения являются нетипичными, что может приводить к искаженным вычислениям. Согласно рекомендациям авторитетных источников, лучше удалять наблюдения, расстояния Кука для которых превышают 1, у нас в наборе таких нет. Но мы можем попробовать удалить переменные, которые вызвали наибольшее количество вопросов, и сравнить результаты.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>Advertising2<span class="ot">&lt;-</span>Advertising[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">131</span>),]</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>mod_2 <span class="ot">=</span> <span class="fu">lm</span>(Sales <span class="sc">~</span> TV <span class="sc">+</span> Radio <span class="sc">+</span> Newspaper, <span class="at">data =</span> Advertising2)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>mtable<span class="ot">&lt;-</span><span class="fu">mtable</span>(mod_1, mod_2)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>mtable</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Calls:
mod_1: lm(formula = Sales ~ TV, data = Advertising)
mod_2: lm(formula = Sales ~ TV + Radio + Newspaper, data = Advertising2)

=======================================
                 mod_1       mod_2     
---------------------------------------
  (Intercept)    7.033***    3.087***  
                (0.458)     (0.281)    
  TV             0.048***    0.044***  
                (0.003)     (0.001)    
  Radio                      0.196***  
                            (0.008)    
  Newspaper                 -0.002     
                            (0.005)    
---------------------------------------
  R-squared      0.612       0.915     
  N            200         198         
=======================================
  Significance: *** = p &lt; 0.001;   
                ** = p &lt; 0.01;   
                * = p &lt; 0.05  </code></pre>
</div>
</div>
<p>После удаления экстремальных наблюдений, качество модели улучшилось (скорректированный <span class="math inline">\(R^2=91.5%\)</span>), хотя общие выводы аналогичны.</p>
</section>
<section id="мультиколлинеарность" class="level4" data-number="12.1.4.4">
<h4 data-number="12.1.4.4" class="anchored" data-anchor-id="мультиколлинеарность"><span class="header-section-number">12.1.4.4</span> Мультиколлинеарность</h4>
<p>Еще один сложный термин))) Что такое мультиколлинеарность? Мультиколлинеарность случается тогда, когда один предиктор может предсказывать другой. Иными словами, мы хотели бы, чтобы предикторы хорошо предсказывали поведение зависимой переменной, но не друг друга, и если такое случается, то это и называется мультиколлинеарностью.Хотя слишком высокая мультиколлинеарность является редкостью, проверка на нее является одной из стандартных процедур регрессионного анализа. Отметим, что проблема мультиколлинеарности является важной, когда мы исследуем важность предикторов, пытаемся на основе интерпретации коэффициентов регрессии обнаружить значимые закономерности (например, доказать, что повышение уровня образования может привести к значительному увеличению доходов или что по мере развития ассоциаций между гражданами увеличивается уровень институционального доверия). Если же первостепенной задачей моделирования является предсказание (как бывает во многих задачах машинного обучения), то проблема мультиколлинеарности не является релевантной, и ее можно проигнорировать.</p>
<p>Как мы можем проверить, если в нашей модели чрезмерная мультиколлинеарность?</p>
<p>Самый простой способ - посмотреть на коэффициенты корреляции между предикторами:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>Advertising <span class="sc">%&gt;%</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(TV, Radio, Newspaper) <span class="sc">%&gt;%</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>()</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  TV      Radio  Newspaper
TV        1.00000000 0.05480866 0.05664787
Radio     0.05480866 1.00000000 0.35410375
Newspaper 0.05664787 0.35410375 1.00000000</code></pre>
</div>
</div>
<p>Наши независимые переменные связаны друг с другом довольно слабо. Специальной мерой, позволяющей проверить мультиколлинеарность, является <span class="math inline">\(VIF - variance inflation factor\)</span>, показывающая увеличение в дисперсии коэффициентов после включения дополнительной переменной:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>car<span class="sc">::</span><span class="fu">vif</span>(mod_2)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       TV     Radio Newspaper 
 1.008207  1.144016  1.141657 </code></pre>
</div>
</div>
<p>VIF &lt; 3 обозначает слабую корреляцию между переменными (идеальные условия). Чаще всего в литературе приводится пороговое значение <span class="math inline">\(VIF=5\)</span>, и только переменные <span class="math inline">\(VIF&lt;5\)</span> должны быть включены в модель.</p>
<p>У нас в модели с мультиколлинеарностью все в порядке.</p>
</section>
</section>
<section id="линейная-регрессия-с-категориальными-предикторами" class="level3" data-number="12.1.5">
<h3 data-number="12.1.5" class="anchored" data-anchor-id="линейная-регрессия-с-категориальными-предикторами"><span class="header-section-number">12.1.5</span> Линейная регрессия с категориальными предикторами</h3>
<p>Напомним, что <strong>категориальные переменные</strong> (также известные, как качественные, или факторные переменные) - это такие переменные, которые позволяют разделить наблюдения на группы. Их особенностями является ограниченное количество значений (уровней). Типичными являются примеры с полом (два уровня - мужчины и женщины) или национальностью, социальным статусом или уровнем образования (например, лица с общим средним, средним профессиональным и высшим образованием).</p>
<p>Обычно регрессионный анализ проводится с количественными переменными, и когда исследователь желает включить в модель категориальную переменную, необходимы некоторые шаги, чтобы сделать результаты более интерпретируемыми.</p>
<p>В частности, категориальные переменные перекодируются в набор так называемых «dummy» (фиктивных) переменных, в результате создается <strong>матрица контрастов</strong>. Современные программы, в том числе и R, «умеют» это делать автоматически.</p>
<blockquote class="blockquote">
<p><iconify-icon inline="" icon="arcticons:anz" style="font-size: 42px;"></iconify-icon> <strong>Пример</strong>: воспользуемся набором данных <code>Salaries</code> из пакета <code>car</code>, в котором содержатся данные о зарплате ассистентов, ассоциированных профессоров и профессоров в одном из американских колледжей (данные - за 2008-2009 учебный год). Данные были собраны администрацией для того, чтобы отслеживать различия между зарплатой, получаемой преподавателями мужчинами и женщинами,</p>
</blockquote>
<p>Загрузим данные:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Salaries"</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Salaries, <span class="dv">3</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      rank discipline yrs.since.phd yrs.service  sex salary
1     Prof          B            19          18 Male 139750
2     Prof          B            20          16 Male 173200
3 AsstProf          B             4           3 Male  79750</code></pre>
</div>
</div>
<section id="категориальные-переменные-с-двумя-уровнями" class="level4" data-number="12.1.5.1">
<h4 data-number="12.1.5.1" class="anchored" data-anchor-id="категориальные-переменные-с-двумя-уровнями"><span class="header-section-number">12.1.5.1</span> Категориальные переменные с двумя уровнями</h4>
<p>Вспомним, что в регрессионном уравнении для того, чтобы предсказать переменную <span class="math inline">\(y\)</span> на основе независимой переменной <span class="math inline">\(x\)</span>, нужно суммировать все основные компоненты:</p>
<p><span class="math display">\[y = b0 + b1*x\]</span></p>
<p>При этом:</p>
<ul>
<li><span class="math inline">\(b_0\)</span> и <span class="math inline">\(b_1\)</span> являются регрессионными коэффициентами, представляющими константу (интерцепт) и угол наклона регрессионной прямой (<code>slope</code>).</li>
</ul>
<p>Допустим, мы хотим проанализировать различия в заработной плате у мужчин и женщин.</p>
<p>На основе переменной пола, мы можем создать новую фиктивную переменную, которая будет принимать значения:</p>
<ul>
<li>1 если преподаватель мужчина</li>
<li>0 если преподаватель женщина</li>
</ul>
<p>и использовать эту переменную в регрессионном уравнении. При этом интерпретация коэффициентов и самого уравнения будет следующей:</p>
<ul>
<li><span class="math inline">\(b_0\)</span> средняя зарплата у женщин,</li>
<li><span class="math inline">\(b_0 + b_1\)</span> средняя зарплата у мужчин,</li>
<li><span class="math inline">\(b_1\)</span> различия в среднем между зарплатой мужчин и женщин.</li>
</ul>
<p>Создадим модель:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>mod_6  <span class="ot">&lt;-</span> <span class="fu">lm</span>(salary <span class="sc">~</span> sex, <span class="at">data =</span> Salaries)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_6)<span class="sc">$</span>coef</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Estimate Std. Error   t value     Pr(&gt;|t|)
(Intercept) 101002.41   4809.386 21.001103 2.683482e-66
sexMale      14088.01   5064.579  2.781674 5.667107e-03</code></pre>
</div>
</div>
<p>Исходя из выведенной информации, средняя зарплата у преподавателей женщин - 101002 долларов (за 9 месяцев), тогда как у мужчин <code>101002 + 14088 = 115090</code>. Полученное p-значение для фиктивной переменной <code>sexMale</code> очень значимое, что указывает на то, что имеются статистические обоснования наличия различий в зарплате по полу.</p>
<p>Функция <code>contrasts()</code>позволяет посмотреть код, который использовался для создания фиктивных переменных:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(Salaries<span class="sc">$</span>sex)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Male
Female    0
Male      1</code></pre>
</div>
</div>
<p>При такой кодировке женщины являются референтной группой, с которой сравниваются мужчины, и в целом, любая подобная кодировка является условной, ее результаты будут влиять только на интерпретацию коэффициентов регрессии.</p>
<p>Если нас такая кодировка не устраивает, мы можем использовать функцию <code>relevel()</code> для смены уровней:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>Salaries <span class="ot">&lt;-</span> Salaries <span class="sc">%&gt;%</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sex =</span> <span class="fu">relevel</span>(sex, <span class="at">ref =</span> <span class="st">"Male"</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>После перекодировки результаты регрессионного анализа будут следующими:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>mod_7 <span class="ot">&lt;-</span> <span class="fu">lm</span>(salary <span class="sc">~</span> sex, <span class="at">data =</span> Salaries)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_7)<span class="sc">$</span>coef</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Estimate Std. Error   t value      Pr(&gt;|t|)
(Intercept) 115090.42   1587.378 72.503463 2.459122e-230
sexFemale   -14088.01   5064.579 -2.781674  5.667107e-03</code></pre>
</div>
</div>
<p>Поскольку мы теперь сравниваем зарплату женщин с зарплатой мужчин, коэффициент переменной <code>sexFemale</code> негативный, что означает более низкий уровень зарплат у женщин, по сравнению с мужчинами.</p>
<p>Коэффициент <span class="math inline">\(b_0\)</span> равено 115090 (средняя зарплата у мужчин), тогда как коэффициент <span class="math inline">\(b_1\)</span> - -14088, показывает, на сколько, в среднем, ниже зарплата у женщин. Соответственно, 115090 - 14088 = 101002 - средняя зарплата женщин.</p>
</section>
<section id="категориальная-переменная-с-более-чем-двумя-уровнями" class="level4" data-number="12.1.5.2">
<h4 data-number="12.1.5.2" class="anchored" data-anchor-id="категориальная-переменная-с-более-чем-двумя-уровнями"><span class="header-section-number">12.1.5.2</span> Категориальная переменная с более чем двумя уровнями</h4>
<p>Что делать, если в качественной переменной, которую мы хотим использовать, более двух уровней? Наиболее типичным является подход, когда такая категориальная переменная трансформируется в <code>n-1</code> бинарных переменных, каждая из которых имеет по два уровня. И эти <code>n-1</code> новых переменных содержат ту же информацию, что исходная переменная. В результате такой кодировки создается таблица контрастов.</p>
<p>Например, в нашем наборе есть переменная <code>rank</code>, которая имеет три уровня: <code>AsstProf</code>, <code>AssocProf</code> и <code>Prof</code>. Мы можем создать две фиктивных переменных - <code>AssocProf</code> и <code>Prof</code>:</p>
<ul>
<li>если <code>rank = AssocProf</code>, тогда в новом столбце <code>AssocProf</code> преподавателями, являющими ассоциированными профессорами, будет присвоено значение 1, а профессорам - 0.</li>
<li>если <code>rank = Prof</code>, тогда в новом столбце <code>Prof</code> все профессора получат значение 1, а ассоциированные профессора - 0.<br>
</li>
<li>что же с ассистентами? В обоих новых столбцах они получат значение 0.</li>
</ul>
<p>Такого рода кодировка в R осуществляется автоматически. С помощью функции <code>model.matrix()</code> мы можем посмотреть, как такая матрица контрастов может выглядеть:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>rank, <span class="at">data =</span> Salaries)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res[, <span class="sc">-</span><span class="dv">1</span>])</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  rankAssocProf rankProf
1             0        1
2             0        1
3             0        0
4             0        1
5             0        1
6             1        0</code></pre>
</div>
</div>
<p>В практике регрессионного анализа есть различные способы кодирования категориальных переменных (создания контрастов). По умолчанию в R первый уровень используется в качестве референтного, а остальные интерпретируются уже по отношению к этому уровню.</p>
<div class="{callout-tip}">
<p>Пример, который мы только что рассмотрели, показывает, что дисперсионный анализ - ANOVA (analyse of variance) является специальным случаем линейной модели, в которой предикторами являются категориальные переменные. И поскольку R это тоже «понимает», мы можем извлечь из модели результаты дисперсионного анализа (предпочтительнее использовать функцию <code>Anova()</code> из пакета <code>car</code> (car означает Companion to Applied Regression - компаньон для прикладных задач регрессионного анализа).</p>
</div>
<p>Создадим модель, в которой мы будем предсказывать зарплату от всех других переменных в наборе (знак плюс означает, что мы будем рассматривать только главные эффекты, без интеракций):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>mod_8<span class="ot">&lt;-</span> <span class="fu">lm</span>(salary <span class="sc">~</span> yrs.service <span class="sc">+</span> rank <span class="sc">+</span> discipline <span class="sc">+</span> sex,</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> Salaries)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(mod_8)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Anova Table (Type II tests)

Response: salary
                Sum Sq  Df  F value    Pr(&gt;F)    
yrs.service 3.2448e+08   1   0.6324    0.4270    
rank        1.0288e+11   2 100.2572 &lt; 2.2e-16 ***
discipline  1.7373e+10   1  33.8582 1.235e-08 ***
sex         7.7669e+08   1   1.5137    0.2193    
Residuals   2.0062e+11 391                       
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>После того, как мы приняли во внимание другие переменные (стаж - yrs.service, должность - rank, область знаний - discipline), стало понятно, что фактор пола уже не имеет значения и не вносит вклада в вариабельность заработной платы. Значимыми становятся должность и область знания.</p>
<p>Чтобы вывести более подробные результаты анализа, лучше воспользоваться функцией <code>summary()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_8)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = salary ~ yrs.service + rank + discipline + sex, 
    data = Salaries)

Residuals:
   Min     1Q Median     3Q    Max 
-64202 -14255  -1533  10571  99163 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   73122.92    3245.27  22.532  &lt; 2e-16 ***
yrs.service     -88.78     111.64  -0.795 0.426958    
rankAssocProf 14560.40    4098.32   3.553 0.000428 ***
rankProf      49159.64    3834.49  12.820  &lt; 2e-16 ***
disciplineB   13473.38    2315.50   5.819 1.24e-08 ***
sexFemale     -4771.25    3878.00  -1.230 0.219311    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 22650 on 391 degrees of freedom
Multiple R-squared:  0.4478,    Adjusted R-squared:  0.4407 
F-statistic: 63.41 on 5 and 391 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Результаты показывают, что зарплата ассоциированного профессора в среднем на 14560.40 долларов выше, чем у ассистента, при прочих равных условиях, а у профессора - выше на 49159.64 долларов. Интересно, что зарплата значительно варьирует от специализации: на прикладных кафедрах (applied departments) наблюдается в среднем на 13473.38 долее высокая зарплата, по сравнению с теоретическими дисциплинами (theoretical departments).</p>
</section>
<section id="интеракции" class="level4" data-number="12.1.5.3">
<h4 data-number="12.1.5.3" class="anchored" data-anchor-id="интеракции"><span class="header-section-number">12.1.5.3</span> Интеракции</h4>
<p>Интеракции происходят тогда, когда эффект одного из предикторов зависит от другой переменной в модели. Чтобы продемонстрировать эффект интеракции, рассмотрим взаимосвязь между должностью и областью знаний в примере про зарплату преподавателей:</p>
<p><span class="math display">\[y_i=\beta_0 + \beta_1*(rank) + \beta_2*(discipline) + \beta_3*(rank*discipline) + \beta_4*(yrs.service) + \beta_5*(sex) + \varepsilon_i\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>mod_9 <span class="ot">&lt;-</span> <span class="fu">lm</span>(salary <span class="sc">~</span> yrs.service <span class="sc">+</span> sex <span class="sc">+</span> rank <span class="sc">*</span> discipline, <span class="at">data =</span> Salaries)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_9)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = salary ~ yrs.service + sex + rank * discipline, 
    data = Salaries)

Residuals:
   Min     1Q Median     3Q    Max 
-64153 -14387  -1511  10675  99229 

Coefficients:
                          Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)               75387.60    4743.67  15.892  &lt; 2e-16 ***
yrs.service                 -86.26     111.91  -0.771    0.441    
sexFemale                 -4974.39    3897.08  -1.276    0.203    
rankAssocProf              9603.29    6543.62   1.468    0.143    
rankProf                  46972.83    5627.26   8.347 1.24e-15 ***
disciplineB                9987.33    5802.62   1.721    0.086 .  
rankAssocProf:disciplineB  8023.36    8189.27   0.980    0.328    
rankProf:disciplineB       3246.32    6446.03   0.504    0.615    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 22680 on 389 degrees of freedom
Multiple R-squared:  0.4492,    Adjusted R-squared:  0.4393 
F-statistic: 45.32 on 7 and 389 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<div class="{callout-tip}">
<p>Отметим, что хотя в формуле мы указали только интеракцию, в выводе содержатся также сведения и об индивидуальных эффектах. R включает эту информацию автоматически.</p>
</div>
<p>Интерпретируя результаты отметим, что эффект от взаимосвязи не значим, и единственным значимым предиктором в модели остается должность: значительная прибавка в зарплате отмечается только у профессоров, тогда как дисциплинарная принадлежность значима только на уровне статистической тенденции (<span class="math inline">\(p=0,086\)</span>).</p>
</section>
<section id="отбор-переменных-для-модели" class="level4" data-number="12.1.5.4">
<h4 data-number="12.1.5.4" class="anchored" data-anchor-id="отбор-переменных-для-модели"><span class="header-section-number">12.1.5.4</span> Отбор переменных для модели</h4>
<p>Прежде чем перейти к моделированию, аналитик проводит тщательную работу по отбору переменных. Обычно, этому предшествует теоретический анализ, который позволит определить, какие показатели, важные для целевой переменной, необходимо включить в исследование, а затем - в модель.</p>
<p>Однако, когда эксперимент уже проведен, наступает время проверки статистических гипотез. Очевидно, что не всегда все включаемые в модель параметры, в конце концов оказываются значимыми.</p>
<p>Какие алгоритмы мы можем использовать для определения финальной, самой лучшей модели из возможных?</p>
<p>Отбор переменных (variable selection) - это процесс выбора наиболее значимых переменных для включения в регрессионную модель. Методы отбора помогают улучшить производительность модели и избежать чрезмерной подгонки.</p>
<p>В рамках данного занятия мы рассмотрим следующие методы отбора:</p>
<ul>
<li>анализ всех возможных моделей / лучшей модели, определяемой на основе оценке качества модели</li>
<li>пошаговые алгоритмы</li>
</ul>
<p>Для работы мы будем использовать пакет <code>olsrr</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"olsrr"</span>)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(olsrr)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="анализ-всех-возможных-моделей" class="level6" data-number="12.1.5.4.0.1">
<h6 data-number="12.1.5.4.0.1" class="anchored" data-anchor-id="анализ-всех-возможных-моделей"><span class="header-section-number">12.1.5.4.0.1</span> Анализ всех возможных моделей</h6>
<p>Прежде чем мы рассмотрим методы пошагового отбора, давайте вкратце рассмотрим регрессию по всем/лучшим подмножествам. Поскольку они оценивают все возможные комбинации переменных, эти методы требуют больших вычислительных затрат и могут вывести систему из строя, если использовать их с большим набором переменных.</p>
<p>Метод <code>All subset regression</code> (все возможные варианты) представляет результаты по всем возможным комбинациям предикторов. Если у нас есть <span class="math inline">\(k\)</span> потенциальных независимых переменных, не считая константы, то количество отдельных моделей, которые потребуется проанализировать, составит - <span class="math inline">\(2^k\)</span>. Например, если у нас 10 предикторов, то количество моделей - <span class="math inline">\(2^10\)</span> - 1024, а если переменных 20 - то количество комбинаций превышает миллион.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> disp <span class="sc">+</span> hp <span class="sc">+</span> wt <span class="sc">+</span> qsec, <span class="at">data =</span> mtcars)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_step_all_possible</span>(model)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Index N      Predictors  R-Square Adj. R-Square Mallow's Cp
3      1 1              wt 0.7528328     0.7445939  0.70869536
1      2 1            disp 0.7183433     0.7089548  0.67512054
2      3 1              hp 0.6024373     0.5891853  0.50969578
4      4 1            qsec 0.1752963     0.1478062  0.07541973
8      5 2           hp wt 0.8267855     0.8148396  0.78108710
10     6 2         wt qsec 0.8264161     0.8144448  0.77856272
6      7 2         disp wt 0.7809306     0.7658223  0.72532105
5      8 2         disp hp 0.7482402     0.7308774  0.69454380
7      9 2       disp qsec 0.7215598     0.7023571  0.66395284
9     10 2         hp qsec 0.6368769     0.6118339  0.52014395
14    11 3      hp wt qsec 0.8347678     0.8170643  0.78199548
11    12 3      disp hp wt 0.8268361     0.8082829  0.76789526
13    13 3    disp wt qsec 0.8264170     0.8078189  0.76988533
12    14 3    disp hp qsec 0.7541953     0.7278591  0.68301440
15    15 4 disp hp wt qsec 0.8351443     0.8107212  0.77102968</code></pre>
</div>
</div>
</section>
<section id="подборка-лучших-моделей-best-subset-regression" class="level6" data-number="12.1.5.4.0.2">
<h6 data-number="12.1.5.4.0.2" class="anchored" data-anchor-id="подборка-лучших-моделей-best-subset-regression"><span class="header-section-number">12.1.5.4.0.2</span> Подборка лучших моделей (Best Subset Regression)</h6>
<p>Данный метод позволяет отобрать модели, которые являются лучшими по обобщенным критериям модели, например, имеет наибольший <span class="math inline">\(R^2\)</span> или меньшие <span class="math inline">\(MSE\)</span> (средняя квадратичная ошибка) или <span class="math inline">\(AIC\)</span> (информационный критерий Акаике).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> disp <span class="sc">+</span> hp <span class="sc">+</span> wt <span class="sc">+</span> qsec, <span class="at">data =</span> mtcars)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_step_best_subset</span>(model)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Best Subsets Regression    
------------------------------
Model Index    Predictors
------------------------------
     1         wt              
     2         hp wt           
     3         hp wt qsec      
     4         disp hp wt qsec 
------------------------------

                                                   Subsets Regression Summary                                                    
---------------------------------------------------------------------------------------------------------------------------------
                       Adj.        Pred                                                                                           
Model    R-Square    R-Square    R-Square     C(p)        AIC        SBIC        SBC         MSEP       FPE       HSP       APC  
---------------------------------------------------------------------------------------------------------------------------------
  1        0.7528      0.7446      0.7087    12.4809    166.0294    74.2916    170.4266    296.9167    9.8572    0.3199    0.2801 
  2        0.8268      0.8148      0.7811     2.3690    156.6523    66.5755    162.5153    215.5104    7.3563    0.2402    0.2091 
  3        0.8348      0.8171       0.782     3.0617    157.1426    67.7238    164.4713    213.1929    7.4756    0.2461    0.2124 
  4        0.8351      0.8107       0.771     5.0000    159.0696    70.0408    167.8640    220.8882    7.9497    0.2644    0.2259 
---------------------------------------------------------------------------------------------------------------------------------
AIC: Akaike Information Criteria 
 SBIC: Sawa's Bayesian Information Criteria 
 SBC: Schwarz Bayesian Criteria 
 MSEP: Estimated error of prediction, assuming multivariate normality 
 FPE: Final Prediction Error 
 HSP: Hocking's Sp 
 APC: Amemiya Prediction Criteria </code></pre>
</div>
</div>
</section>
<section id="пошаговый-отбор-stepwise-selection" class="level6" data-number="12.1.5.4.0.3">
<h6 data-number="12.1.5.4.0.3" class="anchored" data-anchor-id="пошаговый-отбор-stepwise-selection"><span class="header-section-number">12.1.5.4.0.3</span> Пошаговый отбор (Stepwise Selection)</h6>
<p><strong>Пошаговая регрессия</strong> - это метод подбора регрессионных моделей, который предполагает итерационный отбор независимых переменных для использования в модели. Он может быть реализован с помощью прямого отбора, обратного исключения или комбинации обоих методов.</p>
<p>Метод <strong>прямого отбора</strong> начинается с модели без предикторов и постепенно добавляет каждую новую переменную, проверяя ее статистическую значимость, а метод <strong>обратного исключения</strong>, напротив,ю начинается с полной модели и затем по очереди удаляет наименее статистически значимые переменные.</p>
<blockquote class="blockquote">
<p><iconify-icon inline="" icon="arcticons:anz" style="font-size: 42px;"></iconify-icon> <strong>Пример</strong>: Для иллюстрации возможностей пошагового отбора воспользуемся данными из области недвижимости (HousingData).Набор включает данные по 506 объектам недвижимости, оцененных по 14 показателям.</p>
</blockquote>
<p>Переменные:</p>
<ul>
<li>CRIM : уровень преступности</li>
<li>ZN : proportion of residential land zoned for lots over 25,000 sq.ft.</li>
<li>INDUS : доля промышленных предприятий среди нежилых объектов</li>
<li>CHAS : дамми переменная, показывает расположение относительно главной реки</li>
<li>NOX : концентрация нитрита озота</li>
<li>RM : среднее количество комнат</li>
<li>AGE : доля зданий, построенных до 1940</li>
<li>DIS : взвешенное расстояние до пяти значимых бостонских деловых центров</li>
<li>RAD : индекс доступности хайвея</li>
<li>TAX : налоги</li>
<li>PTRATIO : соотношение между учителями и преподавателями (обеспеченность учителями)</li>
<li>B : доля чернокожено населения</li>
<li>LSTAT : доля населения с низкими доходами</li>
<li>MEDV : медианная стоимость в 1000 долларов</li>
</ul>
<p><iconify-icon inline="" icon="arcticons:1dm" style="font-size: 42px;"></iconify-icon><a href="https://www.kaggle.com/datasets/altavish/boston-housing-dataset/data">Скачать данные</a></p>
<p>Загрузим данные и создадим общую модель:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>HousingData<span class="ot">&lt;-</span><span class="fu">read.csv</span>(<span class="st">"HousingData.csv"</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(MEDV <span class="sc">~</span> ., <span class="at">data =</span> HousingData)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = MEDV ~ ., data = HousingData)

Residuals:
     Min       1Q   Median       3Q      Max 
-15.4234  -2.5830  -0.5079   1.6681  26.2604 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  32.680059   5.681290   5.752 1.81e-08 ***
CRIM         -0.097594   0.032457  -3.007 0.002815 ** 
ZN            0.048905   0.014398   3.397 0.000754 ***
INDUS         0.030379   0.065933   0.461 0.645237    
CHAS          2.769378   0.925171   2.993 0.002940 ** 
NOX         -17.969028   4.242856  -4.235 2.87e-05 ***
RM            4.283252   0.470710   9.100  &lt; 2e-16 ***
AGE          -0.012991   0.014459  -0.898 0.369504    
DIS          -1.458510   0.211007  -6.912 2.03e-11 ***
RAD           0.285866   0.069298   4.125 4.55e-05 ***
TAX          -0.013146   0.003955  -3.324 0.000975 ***
PTRATIO      -0.914582   0.140581  -6.506 2.44e-10 ***
B             0.009656   0.002970   3.251 0.001251 ** 
LSTAT        -0.423661   0.055022  -7.700 1.19e-13 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.487 on 380 degrees of freedom
  (112 пропущенных наблюдений удалены)
Multiple R-squared:  0.7671,    Adjusted R-squared:  0.7591 
F-statistic: 96.29 on 13 and 380 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Метод ступенчатого включения (начинаем с нулевой модели и постепенно добавляем предикторы)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_step_forward_p</span>(model)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                               Stepwise Summary                               
----------------------------------------------------------------------------
Step    Variable        AIC         SBC         SBIC        R2       Adj. R2 
----------------------------------------------------------------------------
 0      Base Model    2864.955    2872.908    1744.164    0.00000    0.00000 
 1      LSTAT         2549.957    2561.886    1429.569    0.55272    0.55158 
 2      RM            2445.616    2461.522    1325.564    0.65852    0.65677 
 3      PTRATIO       2391.749    2411.631    1272.076    0.70366    0.70138 
 4      B             2377.429    2401.287    1257.753    0.71569    0.71276 
 5      CHAS          2367.576    2395.411    1247.924    0.72411    0.72056 
 6      DIS           2361.466    2393.277    1241.828    0.72973    0.72554 
 7      NOX           2337.205    2372.992    1218.357    0.74716    0.74258 
 8      ZN            2330.955    2370.719    1212.385    0.75240    0.74725 
 9      CRIM          2328.804    2372.544    1210.391    0.75499    0.74925 
 10     RAD           2324.806    2372.522    1206.697    0.75870    0.75240 
 11     TAX           2313.853    2365.546    1196.546    0.76650    0.75978 
----------------------------------------------------------------------------

Final Model Output 
------------------

                         Model Summary                           
----------------------------------------------------------------
R                       0.875       RMSE                  4.412 
R-Squared               0.767       MSE                  20.081 
Adj. R-Squared          0.760       Coef. Var            20.042 
Pred R-Squared          0.743       AIC                2313.853 
MAE                     3.067       SBC                2365.546 
----------------------------------------------------------------
 RMSE: Root Mean Square Error 
 MSE: Mean Square Error 
 MAE: Mean Absolute Error 
 AIC: Akaike Information Criteria 
 SBC: Schwarz Bayesian Criteria 

                                 ANOVA                                  
-----------------------------------------------------------------------
                 Sum of                                                
                Squares         DF    Mean Square       F         Sig. 
-----------------------------------------------------------------------
Regression    25181.422         11       2289.220    113.998    0.0000 
Residual       7671.047        382         20.081                      
Total         32852.468        393                                     
-----------------------------------------------------------------------

                                    Parameter Estimates                                     
-------------------------------------------------------------------------------------------
      model       Beta    Std. Error    Std. Beta      t        Sig       lower      upper 
-------------------------------------------------------------------------------------------
(Intercept)     32.975         5.631                  5.856    0.000     21.904     44.046 
      LSTAT     -0.440         0.052       -0.352    -8.532    0.000     -0.541     -0.339 
         RM      4.167         0.455        0.318     9.149    0.000      3.271      5.063 
    PTRATIO     -0.915         0.139       -0.217    -6.599    0.000     -1.187     -0.642 
          B      0.009         0.003        0.093     3.201    0.001      0.004      0.015 
       CHAS      2.788         0.920        0.077     3.031    0.003      0.980      4.596 
        DIS     -1.421         0.197       -0.326    -7.201    0.000     -1.808     -1.033 
        NOX    -18.468         3.895       -0.228    -4.741    0.000    -26.127    -10.809 
         ZN      0.050         0.014        0.131     3.526    0.000      0.022      0.078 
       CRIM     -0.098         0.032       -0.099    -3.029    0.003     -0.162     -0.034 
        RAD      0.282         0.066        0.267     4.309    0.000      0.153      0.411 
        TAX     -0.012         0.003       -0.228    -3.573    0.000     -0.019     -0.006 
-------------------------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>Метод пошагового исключения:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_step_backward_p</span>(model)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                               Stepwise Summary                               
----------------------------------------------------------------------------
Step    Variable        AIC         SBC         SBIC        R2       Adj. R2 
----------------------------------------------------------------------------
 0      Full Model    2316.815    2376.460    1199.720    0.76711    0.75915 
 1      INDUS         2315.035    2370.704    1197.851    0.76698    0.75965 
 2      AGE           2313.853    2365.546    1196.546    0.76650    0.75978 
----------------------------------------------------------------------------

Final Model Output 
------------------

                         Model Summary                           
----------------------------------------------------------------
R                       0.875       RMSE                  4.412 
R-Squared               0.767       MSE                  20.081 
Adj. R-Squared          0.760       Coef. Var            20.042 
Pred R-Squared          0.743       AIC                2313.853 
MAE                     3.067       SBC                2365.546 
----------------------------------------------------------------
 RMSE: Root Mean Square Error 
 MSE: Mean Square Error 
 MAE: Mean Absolute Error 
 AIC: Akaike Information Criteria 
 SBC: Schwarz Bayesian Criteria 

                                 ANOVA                                  
-----------------------------------------------------------------------
                 Sum of                                                
                Squares         DF    Mean Square       F         Sig. 
-----------------------------------------------------------------------
Regression    25181.422         11       2289.220    113.998    0.0000 
Residual       7671.047        382         20.081                      
Total         32852.468        393                                     
-----------------------------------------------------------------------

                                    Parameter Estimates                                     
-------------------------------------------------------------------------------------------
      model       Beta    Std. Error    Std. Beta      t        Sig       lower      upper 
-------------------------------------------------------------------------------------------
(Intercept)     32.975         5.631                  5.856    0.000     21.904     44.046 
       CRIM     -0.098         0.032       -0.099    -3.029    0.003     -0.162     -0.034 
         ZN      0.050         0.014        0.131     3.526    0.000      0.022      0.078 
       CHAS      2.788         0.920        0.077     3.031    0.003      0.980      4.596 
        NOX    -18.468         3.895       -0.228    -4.741    0.000    -26.127    -10.809 
         RM      4.167         0.455        0.318     9.149    0.000      3.271      5.063 
        DIS     -1.421         0.197       -0.326    -7.201    0.000     -1.808     -1.033 
        RAD      0.282         0.066        0.267     4.309    0.000      0.153      0.411 
        TAX     -0.012         0.003       -0.228    -3.573    0.000     -0.019     -0.006 
    PTRATIO     -0.915         0.139       -0.217    -6.599    0.000     -1.187     -0.642 
          B      0.009         0.003        0.093     3.201    0.001      0.004      0.015 
      LSTAT     -0.440         0.052       -0.352    -8.532    0.000     -0.541     -0.339 
-------------------------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>Принудительное включение в модель по имени переменной:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_step_forward_p</span>(model, <span class="at">include =</span> <span class="fu">c</span>(<span class="st">"AGE"</span>, <span class="st">"LSTAT"</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                               Stepwise Summary                               
----------------------------------------------------------------------------
Step    Variable        AIC         SBC         SBIC        R2       Adj. R2 
----------------------------------------------------------------------------
 0      Base Model    2549.805    2565.711    1428.520    0.55515    0.55288 
 1      AGE           2795.421    2807.350    1673.446    0.16603    0.16390 
 2      LSTAT         2549.805    2565.711    1428.520    0.55515    0.55288 
 3      RM            2447.070    2466.952    1326.441    0.65899    0.65637 
 4      PTRATIO       2393.728    2417.587    1273.685    0.70368    0.70063 
 5      B             2379.428    2407.262    1259.450    0.71569    0.71202 
 6      DIS           2363.230    2395.041    1243.534    0.72852    0.72431 
 7      NOX           2346.870    2382.657    1227.647    0.74088    0.73618 
 8      CHAS          2336.592    2376.355    1217.770    0.74883    0.74361 
 9      ZN            2331.522    2375.262    1212.973    0.75330    0.74752 
 10     CRIM          2329.117    2376.834    1210.769    0.75604    0.74967 
 11     RAD           2325.744    2377.436    1207.701    0.75935    0.75242 
----------------------------------------------------------------------------

Final Model Output 
------------------

                         Model Summary                           
----------------------------------------------------------------
R                       0.871       RMSE                  4.480 
R-Squared               0.759       MSE                  20.697 
Adj. R-Squared          0.752       Coef. Var            20.346 
Pred R-Squared          0.734       AIC                2325.744 
MAE                     3.107       SBC                2377.436 
----------------------------------------------------------------
 RMSE: Root Mean Square Error 
 MSE: Mean Square Error 
 MAE: Mean Absolute Error 
 AIC: Akaike Information Criteria 
 SBC: Schwarz Bayesian Criteria 

                                 ANOVA                                  
-----------------------------------------------------------------------
                 Sum of                                                
                Squares         DF    Mean Square       F         Sig. 
-----------------------------------------------------------------------
Regression    24946.389         11       2267.854    109.576    0.0000 
Residual       7906.079        382         20.697                      
Total         32852.468        393                                     
-----------------------------------------------------------------------

                                    Parameter Estimates                                     
-------------------------------------------------------------------------------------------
      model       Beta    Std. Error    Std. Beta      t        Sig       lower      upper 
-------------------------------------------------------------------------------------------
(Intercept)     30.750         5.722                  5.374    0.000     19.499     42.001 
        AGE     -0.015         0.015       -0.045    -1.015    0.311     -0.044      0.014 
      LSTAT     -0.432         0.056       -0.346    -7.760    0.000     -0.542     -0.323 
         RM      4.459         0.472        0.340     9.454    0.000      3.532      5.387 
    PTRATIO     -0.982         0.139       -0.233    -7.043    0.000     -1.256     -0.708 
          B      0.010         0.003        0.097     3.300    0.001      0.004      0.016 
        DIS     -1.392         0.209       -0.319    -6.666    0.000     -1.802     -0.981 
        NOX    -20.174         4.054       -0.250    -4.976    0.000    -28.144    -12.203 
       CHAS      3.123         0.930        0.086     3.360    0.001      1.295      4.951 
         ZN      0.037         0.014        0.097     2.623    0.009      0.009      0.065 
       CRIM     -0.093         0.033       -0.094    -2.832    0.005     -0.158     -0.028 
        RAD      0.101         0.044        0.096     2.290    0.023      0.014      0.188 
-------------------------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>Принудительное включение по индексу:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_step_forward_p</span>(model, <span class="at">include =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">7</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                               Stepwise Summary                               
----------------------------------------------------------------------------
Step    Variable        AIC         SBC         SBIC        R2       Adj. R2 
----------------------------------------------------------------------------
 0      Base Model    2770.218    2786.123    1647.004    0.22167    0.21769 
 1      NOX           2773.716    2785.645    1651.853    0.21073    0.20872 
 2      AGE           2770.218    2786.123    1647.004    0.22167    0.21769 
 3      RM            2518.979    2538.861    1397.239    0.59071    0.58757 
 4      LSTAT         2446.035    2469.894    1324.883    0.66161    0.65813 
 5      PTRATIO       2389.609    2417.444    1269.358    0.70825    0.70449 
 6      DIS           2357.931    2389.742    1238.409    0.73215    0.72800 
 7      CHAS          2345.772    2381.559    1226.591    0.74160    0.73692 
 8      B             2336.592    2376.355    1217.770    0.74883    0.74361 
 9      ZN            2331.522    2375.262    1212.973    0.75330    0.74752 
 10     CRIM          2329.117    2376.834    1210.769    0.75604    0.74967 
 11     RAD           2325.744    2377.436    1207.701    0.75935    0.75242 
----------------------------------------------------------------------------

Final Model Output 
------------------

                         Model Summary                           
----------------------------------------------------------------
R                       0.871       RMSE                  4.480 
R-Squared               0.759       MSE                  20.697 
Adj. R-Squared          0.752       Coef. Var            20.346 
Pred R-Squared          0.734       AIC                2325.744 
MAE                     3.107       SBC                2377.436 
----------------------------------------------------------------
 RMSE: Root Mean Square Error 
 MSE: Mean Square Error 
 MAE: Mean Absolute Error 
 AIC: Akaike Information Criteria 
 SBC: Schwarz Bayesian Criteria 

                                 ANOVA                                  
-----------------------------------------------------------------------
                 Sum of                                                
                Squares         DF    Mean Square       F         Sig. 
-----------------------------------------------------------------------
Regression    24946.389         11       2267.854    109.576    0.0000 
Residual       7906.079        382         20.697                      
Total         32852.468        393                                     
-----------------------------------------------------------------------

                                    Parameter Estimates                                     
-------------------------------------------------------------------------------------------
      model       Beta    Std. Error    Std. Beta      t        Sig       lower      upper 
-------------------------------------------------------------------------------------------
(Intercept)     30.750         5.722                  5.374    0.000     19.499     42.001 
        NOX    -20.174         4.054       -0.250    -4.976    0.000    -28.144    -12.203 
        AGE     -0.015         0.015       -0.045    -1.015    0.311     -0.044      0.014 
         RM      4.459         0.472        0.340     9.454    0.000      3.532      5.387 
      LSTAT     -0.432         0.056       -0.346    -7.760    0.000     -0.542     -0.323 
    PTRATIO     -0.982         0.139       -0.233    -7.043    0.000     -1.256     -0.708 
        DIS     -1.392         0.209       -0.319    -6.666    0.000     -1.802     -0.981 
       CHAS      3.123         0.930        0.086     3.360    0.001      1.295      4.951 
          B      0.010         0.003        0.097     3.300    0.001      0.004      0.016 
         ZN      0.037         0.014        0.097     2.623    0.009      0.009      0.065 
       CRIM     -0.093         0.033       -0.094    -2.832    0.005     -0.158     -0.028 
        RAD      0.101         0.044        0.096     2.290    0.023      0.014      0.188 
-------------------------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>Выбор на основе коэффициента детерминации:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_step_forward_adj_r2</span>(model)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                               Stepwise Summary                               
----------------------------------------------------------------------------
Step    Variable        AIC         SBC         SBIC        R2       Adj. R2 
----------------------------------------------------------------------------
 0      Base Model    2864.955    2872.908    1744.164    0.00000    0.00000 
 1      LSTAT         2549.957    2561.886    1429.569    0.55272    0.55158 
 2      RM            2445.616    2461.522    1325.564    0.65852    0.65677 
 3      PTRATIO       2391.749    2411.631    1272.076    0.70366    0.70138 
 4      B             2377.429    2401.287    1257.753    0.71569    0.71276 
 5      CHAS          2367.576    2395.411    1247.924    0.72411    0.72056 
 6      DIS           2361.466    2393.277    1241.828    0.72973    0.72554 
 7      NOX           2337.205    2372.992    1218.357    0.74716    0.74258 
 8      ZN            2330.955    2370.719    1212.385    0.75240    0.74725 
 9      CRIM          2328.804    2372.544    1210.391    0.75499    0.74925 
 10     RAD           2324.806    2372.522    1206.697    0.75870    0.75240 
 11     TAX           2313.853    2365.546    1196.546    0.76650    0.75978 
----------------------------------------------------------------------------

Final Model Output 
------------------

                         Model Summary                           
----------------------------------------------------------------
R                       0.875       RMSE                  4.412 
R-Squared               0.767       MSE                  20.081 
Adj. R-Squared          0.760       Coef. Var            20.042 
Pred R-Squared          0.743       AIC                2313.853 
MAE                     3.067       SBC                2365.546 
----------------------------------------------------------------
 RMSE: Root Mean Square Error 
 MSE: Mean Square Error 
 MAE: Mean Absolute Error 
 AIC: Akaike Information Criteria 
 SBC: Schwarz Bayesian Criteria 

                                 ANOVA                                  
-----------------------------------------------------------------------
                 Sum of                                                
                Squares         DF    Mean Square       F         Sig. 
-----------------------------------------------------------------------
Regression    25181.422         11       2289.220    113.998    0.0000 
Residual       7671.047        382         20.081                      
Total         32852.468        393                                     
-----------------------------------------------------------------------

                                    Parameter Estimates                                     
-------------------------------------------------------------------------------------------
      model       Beta    Std. Error    Std. Beta      t        Sig       lower      upper 
-------------------------------------------------------------------------------------------
(Intercept)     32.975         5.631                  5.856    0.000     21.904     44.046 
      LSTAT     -0.440         0.052       -0.352    -8.532    0.000     -0.541     -0.339 
         RM      4.167         0.455        0.318     9.149    0.000      3.271      5.063 
    PTRATIO     -0.915         0.139       -0.217    -6.599    0.000     -1.187     -0.642 
          B      0.009         0.003        0.093     3.201    0.001      0.004      0.015 
       CHAS      2.788         0.920        0.077     3.031    0.003      0.980      4.596 
        DIS     -1.421         0.197       -0.326    -7.201    0.000     -1.808     -1.033 
        NOX    -18.468         3.895       -0.228    -4.741    0.000    -26.127    -10.809 
         ZN      0.050         0.014        0.131     3.526    0.000      0.022      0.078 
       CRIM     -0.098         0.032       -0.099    -3.029    0.003     -0.162     -0.034 
        RAD      0.282         0.066        0.267     4.309    0.000      0.153      0.411 
        TAX     -0.012         0.003       -0.228    -3.573    0.000     -0.019     -0.006 
-------------------------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>Визуализация модели:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">ols_step_forward_adj_r2</span>(model)</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(k)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Regression_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="иерархический-отбор" class="level6" data-number="12.1.5.4.0.4">
<h6 data-number="12.1.5.4.0.4" class="anchored" data-anchor-id="иерархический-отбор"><span class="header-section-number">12.1.5.4.0.4</span> Иерархический отбор</h6>
<p>Когда для отбора переменных используются p-значения, возможно использования иерархического отбора. Этот метод предполагает, что поиск значимых переменных ограничен следующей переменной. Если какая-то переменная не отбирается по причине не подходящего p-значения, то и ни одна последующая переменная не рассматривается для включения.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ols_step_forward_p</span>(model, <span class="fl">0.1</span>, <span class="at">hierarchical =</span> <span class="cn">TRUE</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                               Stepwise Summary                               
----------------------------------------------------------------------------
Step    Variable        AIC         SBC         SBIC        R2       Adj. R2 
----------------------------------------------------------------------------
 0      Base Model    2864.955    2872.908    1744.164    0.00000    0.00000 
 1      CRIM          2799.295    2811.224    1677.300    0.15779    0.15564 
 2      ZN            2743.805    2759.711    1620.779    0.27213    0.26841 
 3      INDUS         2709.933    2729.815    1585.906    0.33548    0.33037 
 4      CHAS          2691.217    2715.075    1566.162    0.36951    0.36303 
----------------------------------------------------------------------------

Final Model Output 
------------------

                         Model Summary                           
----------------------------------------------------------------
R                       0.608       RMSE                  7.251 
R-Squared               0.370       MSE                  53.247 
Adj. R-Squared          0.363       Coef. Var            32.635 
Pred R-Squared          0.347       AIC                2691.217 
MAE                     5.208       SBC                2715.075 
----------------------------------------------------------------
 RMSE: Root Mean Square Error 
 MSE: Mean Square Error 
 MAE: Mean Absolute Error 
 AIC: Akaike Information Criteria 
 SBC: Schwarz Bayesian Criteria 

                                ANOVA                                  
----------------------------------------------------------------------
                 Sum of                                               
                Squares         DF    Mean Square      F         Sig. 
----------------------------------------------------------------------
Regression    12139.449          4       3034.862    56.996    0.0000 
Residual      20713.019        389         53.247                     
Total         32852.468        393                                    
----------------------------------------------------------------------

                                  Parameter Estimates                                    
----------------------------------------------------------------------------------------
      model      Beta    Std. Error    Std. Beta      t        Sig      lower     upper 
----------------------------------------------------------------------------------------
(Intercept)    26.633         0.901                 29.557    0.000    24.862    28.405 
       CRIM    -0.220         0.044       -0.221    -5.036    0.000    -0.305    -0.134 
         ZN     0.076         0.018        0.200     4.233    0.000     0.041     0.112 
      INDUS    -0.436         0.067       -0.329    -6.527    0.000    -0.567    -0.305 
       CHAS     6.697         1.461        0.185     4.583    0.000     3.824     9.570 
----------------------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>Пошаговая регрессия может оказаться хорошей идеей, особенно, когда количество предикторов велико и нужно отобрать только самые значимые. Между тем, исследователи отмечают большое количество «подводных камней» и статистических проблем, которые могут возникнут в процессе применения регрессионного анализа, таких как переобученность данных, смещенные оценки, ошибки I рода (Harrell, 2015). Кроме того, в процессе применения пошаговых методов возникает опасная иллюзия итого, что компьютер автоматически отбирает правильные переменные, на самом деле это происходит без связи с теоретическими основаниями и гипотезами исследования. Более того, модель, которая была отобрана на основе какого-то критерия, на самом деле может оказаться нестабильной и малоинформативной. Во многих случаях правильным было бы опираться на теорию и предыдущие исследования, тогда как методы отбора могут рассматриваться в качестве поисковых техник.</p>
</section>
</section>
</section>
</section>
<section id="логистическая-регрессия" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="логистическая-регрессия"><span class="header-section-number">12.2</span> Логистическая регрессия</h2>
<p>Логистическая регрессия применяется в том случае, если наша зависимая перменная имеет вид 0-1, то есть является дихотомической и имеет значения 1 и 0. По сути, такой регрессионный анализ решает задачу классификации, то есть определения принадлежности к одному из двух классов (“победит” или “проиграет”, примут на работу или нет и т.д.).</p>
<blockquote class="blockquote">
<p><iconify-icon inline="" icon="arcticons:anz" style="font-size: 42px;"></iconify-icon> <strong>Пример</strong>: В качестве примера, мы будем рассматривать данные о приеме в высшие учебные заведения. В частности, нас будет интересовать, как результаты выпускных экзаменов GRE (Graduate Record Exam scores) и средние оценки GPA (grade point average), а также престиж учебного заведения связаня с допуском в высшее учебное заведение. Зависимой является переменная admit/don’t admit, которая уже закодирована в формате 0-1.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"https://stats.idre.ucla.edu/stat/data/binary.csv"</span>)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  admit gre  gpa rank
1     0 380 3.61    3
2     1 660 3.67    3
3     1 800 4.00    1
4     1 640 3.19    4
5     0 520 2.93    4
6     1 760 3.00    2</code></pre>
</div>
</div>
<p>Модель логистической регрессии имеет вид:</p>
<p><span class="math display">\[
\log\left(\frac{p(x)}{1 - p(x)}\right) = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \cdots  + \beta_p x_p.
\]</span></p>
<p>Откуда, путем перестановки, мы можем вывести вероятность принадлежности к группе 1:</p>
<p><span class="math display">\[
p(x) = \frac{1}{1 + e^{-(\beta_0 + \beta_1 x_1 + \beta_2 x_2 + \cdots  + \beta_p x_p)}} = \sigma(\beta_0 + \beta_1 x_1 + \beta_2 x_2 + \cdots  + \beta_p x_p)
\]</span></p>
<p>Обычно основное уравнение представляется в виде сигмоиды (логистической функции):</p>
<p><span class="math display">\[
\sigma(x) = \frac{e^x}{1 + e^x} = \frac{1}{1 + e^{-x}}
\]</span></p>
<p><img src="https://static.javatpoint.com/tutorial/machine-learning/images/linear-regression-vs-logistic-regression.png" class="img-fluid"></p>
<p>Подгонка модели осуществляется путем максимизации функции правдоподобия, что практически никогда не происходит вручную, и мы предоставим возможность это сделать<code>R</code></p>
<p>Начнем с того, что переведем ранг заведения в факторную переменную:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>rank <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>rank)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>model_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(admit <span class="sc">~</span> gre <span class="sc">+</span> gpa <span class="sc">+</span> rank, <span class="at">data =</span> data, <span class="at">family =</span> <span class="st">"binomial"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Результаты логистической регрессии очень похожи на то, что мы видели в линейной регрессии, только вместо <code>lm()</code> мы используем <code>glm()</code>. Другая особенность - в атрибуте <code>family = "binomial"</code>, что означает, что у нас будет зависимая переменная, состоящая из двух классов. Если использовать <code>glm()</code> с <code>family = "gaussian"</code> то получится обычная линейная регрессия.</p>
<p>Давайте посмотрим на общие результаты</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_glm)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = admit ~ gre + gpa + rank, family = "binomial", 
    data = data)

Coefficients:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -3.989979   1.139951  -3.500 0.000465 ***
gre          0.002264   0.001094   2.070 0.038465 *  
gpa          0.804038   0.331819   2.423 0.015388 *  
rank2       -0.675443   0.316490  -2.134 0.032829 *  
rank3       -1.340204   0.345306  -3.881 0.000104 ***
rank4       -1.551464   0.417832  -3.713 0.000205 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 499.98  on 399  degrees of freedom
Residual deviance: 458.52  on 394  degrees of freedom
AIC: 470.52

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>Вывод в целом напоминает то, что мы видели в линейной регрессии. Видим, что все наши зависимые переменные являются значимыми. Переменные ранга имеют отрицательные коэффициенты, так как сравниваются со значением 1 - группа учебных заведений с наиболее высокими позициями.</p>
<p>Однако, стоит помнить, что коэффициенты в логистической регрессии не простые, они представляют собой логарифм шансов. Что это значит?</p>
<p>Давайте посмотрим на таблицу с нашей зависимой переменной:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data<span class="sc">$</span>admit)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0   1 
273 127 </code></pre>
</div>
</div>
<p>Всего допущено 127 человек из 400, то есть вероятность допуска составит: 127/400=0.3175, а отношение шансов (допуска к недопуску): 0.3175/(1-0.1375)=0.3681159. Логарифм данного выражения составит:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">log</span>(<span class="fl">0.3175</span><span class="sc">/</span>(<span class="dv">1</span><span class="fl">-0.3175</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.7652847</code></pre>
</div>
</div>
<p>Это именно то, что мы бы получили, если бы создали модель только с одним интерцептом:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>model_null<span class="ot">&lt;-</span><span class="fu">glm</span>(admit <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> data, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_null)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = admit ~ 1, family = "binomial", data = data)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  -0.7653     0.1074  -7.125 1.04e-12 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 499.98  on 399  degrees of freedom
Residual deviance: 499.98  on 399  degrees of freedom
AIC: 501.98

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>Вернемся к коэффициентам нашей большой модели:</p>
<ul>
<li>изменения в одну единицу по переменной <code>gre</code>, логарифм шансов допуска увеличится на 0.002.</li>
<li>изменение на одну единицу в <code>gpa</code>, логарифм шансов допуска увеличится на 0.804.</li>
</ul>
<p>Индикаторные переменные для ранга имеют слегка иную интерпретацию. Например, посещая школу, входящую во вторую группу по престижности, по сравнению с группой 1 изменяет логарифм шансов на -0.675.</p>
<p>Внизу таблицы с коэффициентами располагаются индексы подгонки (AIC).</p>
<p>Чтобы перевести коэффициенты в обычное отношение шансов, применяется экспоненциальная функция. Можно соединить это действие с вычислением доверительных интервалов:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">cbind</span>(<span class="at">OR =</span> <span class="fu">coef</span>(model_glm), <span class="fu">confint</span>(model_glm)))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   OR       2.5 %    97.5 %
(Intercept) 0.0185001 0.001889165 0.1665354
gre         1.0022670 1.000137602 1.0044457
gpa         2.2345448 1.173858216 4.3238349
rank2       0.5089310 0.272289674 0.9448343
rank3       0.2617923 0.131641717 0.5115181
rank4       0.2119375 0.090715546 0.4706961</code></pre>
</div>
</div>
<p>Как интерпретировать отношение шансов?</p>
<p>Для количественных переменных меняется мало что:</p>
<ul>
<li>изменение на одну единицу gre на 0,2% увеличивает шансы быть принятыми</li>
<li>изменение среднего балла на единицу увеличивает шансы на 123%</li>
<li>а вот учеба в школе ранга 2 снижает шансы на 50%, ранга 3 - на 73.8%, ранга 4 - на 78,8%.</li>
</ul>
<div class="{callout-tip}">
<p>Общая формула перевода отношения шансов в проценты: (OR-1) * 100</p>
</div>
<p>Следующий этап - посмотреть, как работает функция <code>predict()</code> вместе с <code>glm()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">predict</span>(model_glm))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         1          2          3          4          5          6 
-1.5671256 -0.8848442  1.0377118 -1.5273305 -2.0081113 -0.5323458 </code></pre>
</div>
</div>
<p>По умолчанию <code>predict.glm()</code> использует <code>type = "link"</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">predict</span>(model_glm, <span class="at">type =</span> <span class="st">"link"</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         1          2          3          4          5          6 
-1.5671256 -0.8848442  1.0377118 -1.5273305 -2.0081113 -0.5323458 </code></pre>
</div>
</div>
<p>Это означает, что <code>R</code> возвращает:</p>
<p><span class="math display">\[
\hat{\beta}_0 + \hat{\beta}_1 x_1 + \hat{\beta}_2 x_2 + \cdots  + \hat{\beta}_p x_p
\]</span> для каждого наблюдения.</p>
<p>Важно понимать, что это <strong>не</strong> предсказанные вероятности, и для того, чтобы их получить:</p>
<p><span class="math display">\[
\hat{p}(x) = \hat{P}(Y = 1 \mid X = x)
\]</span></p>
<p>мы должны написать <code>type = "response"</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">predict</span>(model_glm, <span class="at">type =</span> <span class="st">"response"</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        1         2         3         4         5         6 
0.1726265 0.2921750 0.7384082 0.1783846 0.1183539 0.3699699 </code></pre>
</div>
</div>
<p>Соответственно, это вероятности, но <strong>не</strong> результаты классификации. Для того, чтобы их получить, мы должны сравнить вероятности с пороговым значением.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>model_glm_pred <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">predict</span>(model_glm, <span class="at">type =</span> <span class="st">"response"</span>) <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(model_glm_pred)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 2 3 4 5 6 
0 0 1 0 0 0 </code></pre>
</div>
</div>
<p>Что мы сделали?</p>
<p><span class="math display">\[
\hat{C}(x) =
\begin{cases}
      1 &amp; \hat{f}(x) &gt; 0 \\
      0 &amp; \hat{f}(x) \leq 0
\end{cases}
\]</span></p>
<p>где</p>
<p><span class="math display">\[
\hat{f}(x) =\hat{\beta}_0 + \hat{\beta}_1 x_1 + \hat{\beta}_2 x_2 + \cdots  + \hat{\beta}_p x_p.
\]</span></p>
<p>Тот код, который мы запустили, делает следующее:</p>
<p><span class="math display">\[
\hat{C}(x) =
\begin{cases}
      1 &amp; \hat{p}(x) &gt; 0.5 \\
      0 &amp; \hat{p}(x) \leq 0.5
\end{cases}
\]</span></p>
<p>где</p>
<p><span class="math display">\[
\hat{p}(x) = \hat{P}(Y = 1 \mid X = x).
\]</span></p>
<p>Посчитав классификации, мы можем также посчитать метрики для ошибок.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">=</span> <span class="fu">table</span>(<span class="at">predicted =</span> model_glm_pred, <span class="at">actual =</span> data<span class="sc">$</span>admit)</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>tab</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         actual
predicted   0   1
        0 254  97
        1  19  30</code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>confusionMatrix <span class="ot">=</span> <span class="fu">confusionMatrix</span>(tab, <span class="at">positive =</span> <span class="st">"1"</span>)</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(confusionMatrix<span class="sc">$</span>overall[<span class="st">"Accuracy"</span>], </span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>  confusionMatrix<span class="sc">$</span>byClass[<span class="st">"Sensitivity"</span>], </span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>  confusionMatrix<span class="sc">$</span>byClass[<span class="st">"Specificity"</span>])</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Accuracy Sensitivity Specificity 
  0.7100000   0.2362205   0.9304029 </code></pre>
</div>
</div>
<p><img src="https://i.stack.imgur.com/NzSnD.jpg" class="img-fluid"></p>
<p>Мы можем также предсказать результаты допуска в вуз для новых данных.</p>
<p>Попробуем их сгенерировать на основе исходных данных:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>newdata1 <span class="ot">&lt;-</span> <span class="fu">with</span>(data, <span class="fu">data.frame</span>(<span class="at">gre =</span> <span class="fu">mean</span>(gre), <span class="at">gpa =</span> <span class="fu">mean</span>(gpa), <span class="at">rank =</span> <span class="fu">factor</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Предскажем результаты зачисления:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>newdata1<span class="sc">$</span>rankP <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_glm, <span class="at">newdata =</span> newdata1, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>newdata1</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    gre    gpa rank     rankP
1 587.7 3.3899    1 0.5166016
2 587.7 3.3899    2 0.3522846
3 587.7 3.3899    3 0.2186120
4 587.7 3.3899    4 0.1846684</code></pre>
</div>
</div>
<p>Видим, что при средних оценках, учащиеся, обучавшиеся в престижных школах имеют большую вероятность поступить, чем те, кто училися не в очень престижных заведениях.</p>
<p>Мы также можем захотеть узнать, насколько хорошо наша модель соответствует действительности. Это может быть особенно полезно при сравнении конкурирующих моделей.</p>
<p>Аналогом <span class="math inline">\(R^2\)</span> для логистической регрессии является <span class="math inline">\(R^2 Макфаддена\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">summary</span>(model_glm), <span class="dv">1</span> <span class="sc">-</span> deviance<span class="sc">/</span>null.deviance)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.08292194</code></pre>
</div>
</div>
<p>Если не хочется вычислять вручную, можно воспользоваться готовой функцией <code>pR2</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages('pscl')</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pscl)</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a><span class="fu">pR2</span>(model_glm)[<span class="st">'McFadden'</span>]</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>fitting null model for pseudo-r2</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  McFadden 
0.08292194 </code></pre>
</div>
</div>
<p>Еще одной популярной псевдомерой является <span class="math inline">\(R^2 Nagelkerke\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages('fmsb')</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fmsb)</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="fu">NagelkerkeR2</span>(model_glm)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$N
[1] 400

$R2
[1] 0.1379958</code></pre>
</div>
</div>
</section>
<section id="мультиномиальная-логистическая-регрессия" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="мультиномиальная-логистическая-регрессия"><span class="header-section-number">12.3</span> Мультиномиальная логистическая регрессия</h2>
<p>Что делать, если наша зависимая переменная имеет не две, а более категорий? Для этого случая больше подходит мультиномиальная логистическая регрессия.</p>
<p><span class="math display">\[
P(Y = k \mid { X = x}) = \frac{e^{\beta_{0k} + \beta_{1k} x_1 + \cdots +  + \beta_{pk} x_p}}{\sum_{g = 1}^{G} e^{\beta_{0g} + \beta_{1g} x_1 + \cdots + \beta_{pg} x_p}}
\]</span></p>
<p>Мы не будем погружаться в технические детали, но попробуем реализовать этот подход на практике. мы воспользуемся знакомым нам набором данных <code>iris</code>.</p>
<p>Чтобы выполнить мультиномиальный регрессионный анализ нам потребуется функция <code>multinom</code> из библиотеки <code>nnet</code>, где используется синтаксис, похожий на <code>lm()</code> и <code>glm()</code>. Лучше добавить <code>trace = FALSE</code>, чтобы не выводилась информация об оптимизационных процессах во время обучения.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nnet)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>model_multi <span class="ot">=</span> <span class="fu">multinom</span>(Species <span class="sc">~</span> ., <span class="at">data =</span> iris)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># weights:  18 (10 variable)
initial  value 164.791843 
iter  10 value 16.177348
iter  20 value 7.111438
iter  30 value 6.182999
iter  40 value 5.984028
iter  50 value 5.961278
iter  60 value 5.954900
iter  70 value 5.951851
iter  80 value 5.950343
iter  90 value 5.949904
iter 100 value 5.949867
final  value 5.949867 
stopped after 100 iterations</code></pre>
</div>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_multi)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
multinom(formula = Species ~ ., data = iris)

Coefficients:
           (Intercept) Sepal.Length Sepal.Width Petal.Length Petal.Width
versicolor    18.69037    -5.458424   -8.707401     14.24477   -3.097684
virginica    -23.83628    -7.923634  -15.370769     23.65978   15.135301

Std. Errors:
           (Intercept) Sepal.Length Sepal.Width Petal.Length Petal.Width
versicolor    34.97116     89.89215    157.0415     60.19170    45.48852
virginica     35.76649     89.91153    157.1196     60.46753    45.93406

Residual Deviance: 11.89973 
AIC: 31.89973 </code></pre>
</div>
</div>
<p>Заметим, что на выходе у нас коэффициенты только для двух классов, так же как и в обычной регрессии у нас есть только коэффициент для одного класса.</p>
</section>
<section id="непараметрическая-регрессия.-метод-k-ближайших-соседей" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="непараметрическая-регрессия.-метод-k-ближайших-соседей"><span class="header-section-number">12.4</span> Непараметрическая регрессия. Метод k-ближайших соседей</h2>
<p>Все методы, которые мы рассматривали до этого момента, являются параметрическими. Это можно представить в виде обобщающей формулы.</p>
<p><span class="math display">\[
f(x) = \mathbb{E}[Y \mid X = x]
\]</span></p>
<p>Например, типичная форма для множественной линейной регрессии:</p>
<p><span class="math display">\[
f(x) = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \ldots + \beta_p x_p
\]</span></p>
<p>Задача аналитика в этом случае заключается в оценке параметров модели и предсказания на их основе.</p>
<p>Непараметрические методы основываются на самих данных, а не на параметрах. В этом случае используется понятие локальности.</p>
<p>Рассуждения при этом примерно такие: чему будет равняться y, если x равен…?</p>
<p><span class="math display">\[
\hat{f}(x) = \text{average}(\{ y_i : x_i = x \})
\]</span></p>
<p>Поскольку не всегда это требование выполняется, то условия чуть-чуть меняются:</p>
<p><span class="math display">\[
\hat{f}(x) = \text{average}( \{ y_i : x_i \text{ equal to (or very close to) x} \} )
\]</span></p>
<p>Одним из конкретных примером использования непараметрического подхода является метод ближайших соседей:</p>
<p><span class="math display">\[
\hat{f}_k(x) = \frac{1}{k} \sum_{i \in \mathcal{N}_k(x, \mathcal{D})} y_i
\]</span></p>
<p><img src="https://bookdown.org/f100441618/bookdown-regresion/www/KNN.jpg" class="img-fluid"></p>
<section id="knn-в-r" class="level3" data-number="12.4.1">
<h3 data-number="12.4.1" class="anchored" data-anchor-id="knn-в-r"><span class="header-section-number">12.4.1</span> KNN в <code>R</code></h3>
<p>Посмотрим, как работает этот метод на данных набора <code>HousingData</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(FNN)</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Boston)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Создаем тренировочную и тестируемые выборки:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>boston_idx <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(Boston), <span class="at">size =</span> <span class="dv">250</span>)</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>trn_boston <span class="ot">=</span> Boston[boston_idx, ]</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>tst_boston  <span class="ot">=</span> Boston[<span class="sc">-</span>boston_idx, ]</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>X_trn_boston <span class="ot">=</span> trn_boston[<span class="st">"lstat"</span>]</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>X_tst_boston <span class="ot">=</span> tst_boston[<span class="st">"lstat"</span>]</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>y_trn_boston <span class="ot">=</span> trn_boston[<span class="st">"medv"</span>]</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>y_tst_boston <span class="ot">=</span> tst_boston[<span class="st">"medv"</span>]</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Создадим дополнительный набор для переменной <code>lstat</code> по которым мы будем предсказывать <code>medv</code> для создания графики.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>X_trn_boston_min <span class="ot">=</span> <span class="fu">min</span>(X_trn_boston)</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>X_trn_boston_max <span class="ot">=</span> <span class="fu">max</span>(X_trn_boston)</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>lstat_grid <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">lstat =</span> <span class="fu">seq</span>(X_trn_boston_min, X_trn_boston_max, </span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="fl">0.01</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Чтобы применить метод KNN в качестве разновидности регрессионного анализа, нам понадобится функция <code>knn.reg()</code> из библиотеки <code>FNN</code>.</p>
<p>Ее общая архитектура следующая:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="fu">knn.reg</span>(<span class="at">train =</span> ?, <span class="at">test =</span> ?, <span class="at">y =</span> ?, <span class="at">k =</span> ?)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Данные</p>
<ul>
<li><code>train</code>: предикторы (тренировочные данные)</li>
<li><code>test</code>: предикторы на тестовых данных, <span class="math inline">\(x\)</span>, по которым мы хотели бы сделать предсказания</li>
<li><code>y</code>: зависимая переменная (на тренировочных данных)</li>
<li><code>k</code>: количество “соседей”</li>
</ul>
<p>Результат:</p>
<ul>
<li>вывод функции <code>knn.reg()</code> представляет собой <span class="math inline">\(\hat{f}_k(x)\)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>pred_001 <span class="ot">=</span> <span class="fu">knn.reg</span>(<span class="at">train =</span> X_trn_boston, <span class="at">test =</span> lstat_grid, <span class="at">y =</span> y_trn_boston, <span class="at">k =</span> <span class="dv">1</span>)</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>pred_005 <span class="ot">=</span> <span class="fu">knn.reg</span>(<span class="at">train =</span> X_trn_boston, <span class="at">test =</span> lstat_grid, <span class="at">y =</span> y_trn_boston, <span class="at">k =</span> <span class="dv">5</span>)</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>pred_010 <span class="ot">=</span> <span class="fu">knn.reg</span>(<span class="at">train =</span> X_trn_boston, <span class="at">test =</span> lstat_grid, <span class="at">y =</span> y_trn_boston, <span class="at">k =</span> <span class="dv">10</span>)</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>pred_050 <span class="ot">=</span> <span class="fu">knn.reg</span>(<span class="at">train =</span> X_trn_boston, <span class="at">test =</span> lstat_grid, <span class="at">y =</span> y_trn_boston, <span class="at">k =</span> <span class="dv">50</span>)</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>pred_100 <span class="ot">=</span> <span class="fu">knn.reg</span>(<span class="at">train =</span> X_trn_boston, <span class="at">test =</span> lstat_grid, <span class="at">y =</span> y_trn_boston, <span class="at">k =</span> <span class="dv">100</span>)</span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>pred_250 <span class="ot">=</span> <span class="fu">knn.reg</span>(<span class="at">train =</span> X_trn_boston, <span class="at">test =</span> lstat_grid, <span class="at">y =</span> y_trn_boston, <span class="at">k =</span> <span class="dv">250</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Мы сделали предсказания на основе <code>lstat</code>, для различных значений <code>k</code>. Отметим, что <code>250</code> это общее количество наблюдений в тренировочном датасете.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Regression_files/figure-html/unnamed-chunk-86-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Оранжевые “кривые” представляют собой <span class="math inline">\(\hat{f}_k(x)\)</span> где <span class="math inline">\(x\)</span> это значения, которые мы определили через <code>lstat_grid</code>.</li>
</ul>
<p>мы видим, что <code>k = 1</code> приводит к большой переобученности, так как <code>k = 1</code> это очень комплексная, вариативная модель. В свою очередь, <code>k = 250</code> страдает недообученностью данных, так как <code>k = 250</code> это очень простой пример с маленькой дисперсией, то есть по сути, всегда будет предсказываться одно и то же значение.</p>
</section>
<section id="выбор-параметра-k" class="level3" data-number="12.4.2">
<h3 data-number="12.4.2" class="anchored" data-anchor-id="выбор-параметра-k"><span class="header-section-number">12.4.2</span> Выбор параметра <span class="math inline">\(k\)</span></h3>
<p>Дилемма: - низкое значение <code>k</code> = слишком сложная модель - высокое значение <code>k</code> = слишком жесткая модель.</p>
<p>Где золотая середина?</p>
<p>-мы хотим минимизировать <span class="math inline">\(\hat{f}_k\)</span>:</p>
<p><span class="math display">\[
\text{EPE}\left(Y, \hat{f}_k(X)\right) =
\mathbb{E}_{X, Y, \mathcal{D}} \left[  (Y - \hat{f}_k(X))^2 \right]
\]</span></p>
<p>Проведем тестирование на ошибку RMSE:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>rmse <span class="ot">=</span> <span class="cf">function</span>(actual, predicted) {</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>((actual <span class="sc">-</span> predicted) <span class="sc">^</span> <span class="dv">2</span>))</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># создадим вспомогательную функцию, чтобы "вытащить" предсказанные значения</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>make_knn_pred <span class="ot">=</span> <span class="cf">function</span>(<span class="at">k =</span> <span class="dv">1</span>, training, predicting) {</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">=</span> FNN<span class="sc">::</span><span class="fu">knn.reg</span>(<span class="at">train =</span> training[<span class="st">"lstat"</span>], </span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">test =</span> predicting[<span class="st">"lstat"</span>], </span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">y =</span> training<span class="sc">$</span>medv, <span class="at">k =</span> k)<span class="sc">$</span>pred</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>  act  <span class="ot">=</span> predicting<span class="sc">$</span>medv</span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse</span>(<span class="at">predicted =</span> pred, <span class="at">actual =</span> act)</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co"># определяем возможные значения k</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>k <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">250</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Получаем train RMSEs</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>knn_trn_rmse <span class="ot">=</span> <span class="fu">sapply</span>(k, make_knn_pred, </span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">training =</span> trn_boston, </span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">predicting =</span> trn_boston)</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Получаем test RMSEs</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>knn_tst_rmse <span class="ot">=</span> <span class="fu">sapply</span>(k, make_knn_pred, </span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">training =</span> trn_boston, </span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">predicting =</span> tst_boston)</span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Определяем лучшее значение k</span></span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>best_k <span class="ot">=</span> k[<span class="fu">which.min</span>(knn_tst_rmse)]</span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Найдем значения для переобученности, недообученности и для лучшего случая</span></span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>fit_status <span class="ot">=</span> <span class="fu">ifelse</span>(k <span class="sc">&lt;</span> best_k, <span class="st">"Over"</span>, <span class="fu">ifelse</span>(k <span class="sc">==</span> best_k, <span class="st">"Best"</span>, <span class="st">"Under"</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Суммируем результаты</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>knn_results <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>  k,</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(knn_trn_rmse, <span class="dv">2</span>),</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(knn_tst_rmse, <span class="dv">2</span>),</span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>  fit_status</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(knn_results) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"k"</span>, <span class="st">"Train RMSE"</span>, <span class="st">"Test RMSE"</span>, <span class="st">"Fit?"</span>)</span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Отобразим результаты</span></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(knn_results, <span class="at">escape =</span> <span class="cn">FALSE</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">k</th>
<th style="text-align: right;">Train RMSE</th>
<th style="text-align: right;">Test RMSE</th>
<th style="text-align: left;">Fit?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.65</td>
<td style="text-align: right;">8.32</td>
<td style="text-align: left;">Over</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">4.98</td>
<td style="text-align: right;">5.83</td>
<td style="text-align: left;">Over</td>
</tr>
<tr class="odd">
<td style="text-align: right;">10</td>
<td style="text-align: right;">5.26</td>
<td style="text-align: right;">5.05</td>
<td style="text-align: left;">Over</td>
</tr>
<tr class="even">
<td style="text-align: right;">25</td>
<td style="text-align: right;">5.51</td>
<td style="text-align: right;">4.79</td>
<td style="text-align: left;">Best</td>
</tr>
<tr class="odd">
<td style="text-align: right;">50</td>
<td style="text-align: right;">5.94</td>
<td style="text-align: right;">5.05</td>
<td style="text-align: left;">Under</td>
</tr>
<tr class="even">
<td style="text-align: right;">250</td>
<td style="text-align: right;">9.61</td>
<td style="text-align: right;">8.75</td>
<td style="text-align: left;">Under</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Вопрос на засыпку: почему при k=1 ошибка на тренировочной выборке не равна 0?</p>
</section>
<section id="сравнение-с-линейной-регрессией" class="level3" data-number="12.4.3">
<h3 data-number="12.4.3" class="anchored" data-anchor-id="сравнение-с-линейной-регрессией"><span class="header-section-number">12.4.3</span> Сравнение с линейной регрессией</h3>
<p>Если у нас линейная зависимость: - lm() работает хорошо - knn “подгоняет автоматически”</p>
<p>Если связь независимая: - lm() работает плохо - или работает лучше при определенных условиях - knn “делает все автоматически”</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Regression_files/figure-html/unnamed-chunk-92-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Те же шаги, но быстрее, можно осуществить с помощью библиотеки <code>caret</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>model_knn_caret <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>  medv <span class="sc">~</span> .,</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> trn_boston,</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">'knn'</span>,</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">preProcess =</span> <span class="fu">c</span>(<span class="st">"center"</span>, <span class="st">"scale"</span>), <span class="at">tuneLength =</span> <span class="dv">20</span> <span class="co">#этот параметр позволяет рассчитать разное количество соседей</span></span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>model_knn_caret</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>k-Nearest Neighbors 

250 samples
 13 predictor

Pre-processing: centered (13), scaled (13) 
Resampling: Bootstrapped (25 reps) 
Summary of sample sizes: 250, 250, 250, 250, 250, 250, ... 
Resampling results across tuning parameters:

  k   RMSE      Rsquared   MAE     
   5  5.933835  0.6382250  3.799103
   7  5.846760  0.6503739  3.810948
   9  5.794543  0.6596814  3.805512
  11  5.808902  0.6644311  3.820602
  13  5.847843  0.6650228  3.846754
  15  5.917803  0.6610201  3.904047
  17  5.993814  0.6563786  3.954787
  19  6.051791  0.6564321  4.001023
  21  6.142314  0.6497636  4.053036
  23  6.235960  0.6442404  4.138807
  25  6.326002  0.6388550  4.205069
  27  6.403704  0.6345582  4.262726
  29  6.476211  0.6296321  4.305763
  31  6.549668  0.6248754  4.352380
  33  6.615244  0.6199260  4.392180
  35  6.671859  0.6178162  4.432505
  37  6.738799  0.6115130  4.475878
  39  6.800152  0.6062191  4.517187
  41  6.842031  0.6027472  4.542485
  43  6.881135  0.6002764  4.584084

RMSE was used to select the optimal model using the smallest value.
The final value used for the model was k = 9.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>knnPredict <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_knn_caret, <span class="at">newdata =</span> tst_boston)</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>rsq_knn_cv <span class="ot">&lt;-</span> <span class="fu">cor</span>(knnPredict, tst_boston<span class="sc">$</span>medv) <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>rsq_knn_cv</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7549495</code></pre>
</div>
</div>
</section>
</section>
<section id="самостоятельная-работа" class="level2" data-number="12.5">
<h2 data-number="12.5" class="anchored" data-anchor-id="самостоятельная-работа"><span class="header-section-number">12.5</span> Самостоятельная работа</h2>
<ol type="1">
<li>Провести регрессионный анализ данных об успеваемости студентов и определяющих их фактора.</li>
</ol>
<p>Независимые переменные:</p>
<ul>
<li>Hours Studied: Общее количество часов, потраченных на учебу каждым студентом.</li>
<li>Previous Scores - предшествующие результаты: Баллы, полученные студентами на предыдущих экзаменах.</li>
<li>Extracurricular Activities - Внеклассная деятельность: Участвует ли студент во внеклассных мероприятиях (да или нет).</li>
<li>Sleep Hours - Часы сна: Среднее количество часов сна студента в сутки.</li>
<li>Sample Question Papers Practiced: Количество пробных экзаменационных работ, которые студент практиковал.</li>
</ul>
<p>Целевая переменная:</p>
<ul>
<li>Performance Index: Показатель общей успеваемости каждого студента. Индекс успеваемости представляет собой академическую успеваемость студента и округляется до ближайшего целого числа. Индекс варьируется от 10 до 100, при этом более высокие значения свидетельствуют о более высокой успеваемости.</li>
</ul>
<p><iconify-icon inline="" icon="arcticons:1dm" style="font-size: 42px;"></iconify-icon><a href="https://github.com/domelia/rcourse/blob/e53e6c681fb30693f8c0803cfa1bff9141ac50a2/Student_Performance.csv">Скачать данные</a></p>
<ol start="2" type="1">
<li>Провести анализ методом логистической регрессии на данных по климату. В качестве зависимой переменной будет выступать вопрос про оценку опасности проживания вблизи ледников (вопрос 19) , а в качестве объясняющих - пол, возраст и переменная проживания в определенном районе (type).</li>
</ol>


</section>

</main> <!-- /main -->
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  var t = document.getElementsByClassName("webex-total_correct");
  for (var i = 0; i < t.length; i++) {
    p = t[i].parentElement;
    var correct = p.getElementsByClassName("webex-correct").length;
    var solvemes = p.getElementsByClassName("webex-solveme").length;
    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;
    var selects = p.getElementsByClassName("webex-select").length;

    t[i].innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* check answers */
check_func = function() {
  console.log("webex: check answers");

  var cl = this.parentElement.classList;
  if (cl.contains('unchecked')) {
    cl.remove("unchecked");
    this.innerHTML = "Hide Answers";
  } else {
    cl.add("unchecked");
    this.innerHTML = "Show Answers";
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;

  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  var check_sections = document.getElementsByClassName("webex-check");
  console.log("check:", check_sections.length);
  for (var i = 0; i < check_sections.length; i++) {
    check_sections[i].classList.add("unchecked");

    let btn = document.createElement("button");
    btn.innerHTML = "Show Answers";
    btn.classList.add("webex-check-button");
    btn.onclick = check_func;
    check_sections[i].appendChild(btn);

    let spn = document.createElement("span");
    spn.classList.add("webex-total_correct");
    check_sections[i].appendChild(spn);
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    solveme[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    selects[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  update_total_correct();
}

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Скопировано");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Скопировано");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./PCA_CA.html" class="pagination-link  aria-label=" &lt;span="" многомерного="" анализа:="" снижение="" размерности&lt;="" span&gt;"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Основы многомерного анализа: снижение размерности</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="<span class='chapter-number'>13</span>&nbsp; <span class='chapter-title'>Список источников</span>">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Список источников</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/domelia/R-book/edit/main/Regression.qmd" class="toc-action"><i class="bi bi-github"></i>Редактировать страницу</a></li></ul></div></div></div></footer></body></html>