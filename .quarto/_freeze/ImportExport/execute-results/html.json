{
  "hash": "d242327e9b33bbd2f39a8e8f0b807c03",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Импорт и экспорт данных\"\n---\n\n\nВ R можно загрузить данные практически любого формата и из любого источника.\n\nРазберем некоторые наиболее часто встречающиеся ситуации.\n\n## Импорт и экспорт файлов Excel\n\n::: {.alert .alert-primary role=\"alert\"}\n**Важно!**: сохраните все файлы с дополнительными материалами к заданию в ту же директорию, где будете работать (лучше всего создать новый проект под это занятие). Это нужно для того, чтобы лишний раз не прописывать путь к файлу).\n\nЕще один удобный ход - установить в настройках рабочую директорию в ту же папку, где лежит файл со скриптом:\n\nSession - Set Working Directory - To Source File Location\n:::\n\n![](images/ImportExport/read-excel-files.png)\n\nИмпортировать данные из файла Excel можно несколькими способами.\n\n## Способ 1. Скопировать из Excel и сохранить в R.\n\nДля того, чтобы воспользоваться этим способом, [сохраните файл](%22https://github.com/domelia/R-book/blob/main/files/ProgResCompatriots.xlsx%22), откройте его, выделите все данные и скопируйте их (`Ctrl+C`). Затем запустите код ниже:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_data <- read.table(file = \"clipboard\", sep = \"\\t\", header=TRUE)\n```\n:::\n\n\nЕсли все сделано правильно, то у Вас в рабочем окружении появится объект **my_data**, в котором будет 9 наблюдений и 14 переменных (это результаты реализации государственной программы содействия добровольному переселению соотечественников). Чтобы увидеть данные, нажмите на него и он откроется в просмотрщике.\n\n![](images/ImportExport/2022-10-14_09h55_22.png)\n\n## Способ 2. Импорт из файла Excel.\n\nПредположим, файл Excel у нас большой, содержит несколько листов, скопировать все и вставить - не очень удачная идея. В этом случае (честно говоря, такие случаи случаются гораздо чаще, чем описанные в способе 1), нам нужно импортировать данные из файла.\n\nЭто сделать не так сложно, к счастью, у нас есть библиотека `readxl`, которая как раз и предназначена для таких целей.\n\nПорядок действий следующий:\n\n1.  Загружаем библиотеку `readxl`.\n2.  Запускаем функцию `read_excel(file excel, sheet = \"name of sheet\")`\n\nДавайте загрузим тот же файл с соотечественниками, что и в примере выше:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readxl)\ndf_excel<-read_excel(\"ProgResCompatriots.xlsx\", sheet=1)\n```\n:::\n\n\nВ рабочем окружении отобразился новый объект, его содержание идентично my_data. Чтобы посмотреть - нужно нажать на голубой кружок с белым треугольником рядом с именем:\n\n![](images/ImportExport/2022-10-14_10h10_15.png)\n\nПамятка по работе с `readxl`: ![](https://raw.githubusercontent.com/rstudio/cheatsheets/main/pngs/thumbnails/data-import-cheatsheet-thumbs.png)\n\n## Экспорт результатов в Excel\n\nДавайте попробуем создать новую переменную, куда посчитаем среднее количество перехавших за год в период с 2010 по 2021 гг.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\ndf_excel$Среднее<-apply(df_excel[,2:13],1, mean)\n```\n:::\n\n\nУ нас появился новый столбец в конце таблицы.\n\nТеперь эту новую таблицу нужно сохранить в новый файл. Для этого нам понадобится библиотека `xlsx`, а в ней - функция `write.xlxs()`.\n\nЗапустите следующий код:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"xlsx\") #установим библиотеку\nlibrary(xlsx)\nwrite.xlsx(df_excel, \"df_excel_new.xlsx\")\n```\n:::\n\n\n## Импорт и экспорт файла в формате CSV\n\nCSV (от англ. Comma-Separated Values — значения, разделённые запятыми) — текстовый формат, предназначенный для представления табличных данных. Строка таблицы соответствует строке текста, которая содержит одно или несколько полей, разделенных запятыми, то есть, по сути, это данные, представленные в текстовом формате.\n\nСтатистическая информация часто хранится именно в формате CSV, этому формату уже более 40 лет. Текстовые файлы открываются читаются на любом устройстве и в любой среде без дополнительных инструментов. Из-за своих преимуществ CSV — сверхпопулярный формат обмена данными.\n\nЗа импорт таких файлов отвечает библиотека `readr`, а в ней - функция `read_csv2` (есть и просто `read_csv`, но там - разделитель действительно запятая, а в `read_csv2` - точка с запятой). В чем проблема? Проблема в том, что в России запятая используется в качестве разделителя десятичных разрядов, и когда мы начинаем сохранять в формате `csv` возникает конфликт. Чтобы его не было, программа вместо запятой использует разделитель - точку с запятой. Это хорошо видно, если посмотреть, как эти данные выглядят в блокноте.\n\nЕсть и аналогичные функции базового R - `read.csv()`и `read.csv2`. Их отличие от функций `read_csv2` и `read_csv`заключается в быстроте последних, нюансах в обработке строковых переменных (базовые функции принудительно преобразуют их в факторные переменные, тогда как более современные `read_csv2` и `read_csv` оставляют тип `character`). Есть и некоторые другие отличие, но их обсуждение выходит за рамки данного пособия.\n\nПорядок действий:\n\n1.  Скачать [файл в формате csv](https://github.com/domelia/R-book/blob/main/files/ProgResCompatriots.csv).\n\n2.  Отрыть файл:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readr)\ndf_csv<-read_csv2(\"ProgResCompatriots.csv\")\n```\n:::\n\n\nУ нас теперь уже три файла с одинаковыми данными). Что с ними делать? Что-нибудь придумаем по ходу занятия...\n\nНапример, давайте посчитаем прирост соотечественников в 2021 году по сравнению с 2020 годом.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_csv$change2021<-df_csv$`2021`-df_csv$`2020`\n```\n:::\n\n\nСохраним наш файл в этом же формате:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite.csv2(df_csv, \"df_csv_new.csv\")\n```\n:::\n\n\n## Импорт файла по URL\n\nВ Интернете хранится огромное количество различных данных, но с точки зрения импорта можно рассмотреть несколько случаев:\n\n-   когда нам нужно просто загрузить файл из Интернета и сохранить его в директорию\n-   когда ссылка является прямой и по ней мы можем загрузить данные определенного формата\n-   когда у нас есть ссылка на ресурс, в котором содержатся данные вперемешку с текстом, и нам нужно сохранить только табличные данные\n\n### Загрузка файла в рабочую папку\n\nВоспользуемся данными, представленными на портале \"Открытые данные России\" и скачаем оттуда перечень стран и режимов въезда на их территорию.\n\nМы будем использовать очень простую фунцию download.file(), в которой мы должны указать два аргумента - ссылку и имя файла, в который мы будем сохранять данные. Заметьте, что формат выгружаемого и сохраняемого файла должны совпадать.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndownload.file(\"https://www.isras.ru/files/File/Bank/010%2080055.pdf\", \"anketa.pdf\", mode=\"wb\")#\n```\n:::\n\n\nПосмотрите в своей рабочей директории, скачался ли файл, попробуйте его открыть.\n\n### Импорт по прямой ссылке в формате csv\n\nЗдесь тоже нет ничего сложного. Мы уже только что пробовали открывать файлы в формате csv, которые хранятся у нас на компьютере. То же самое происходит с ссылками из Интернета.\n\nЗагрузим данные об исследованиии по науке и разработкам, представленное на портале статистического Информационного центра при правительстве Новой Зеландии:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSys.getlocale()\nlibrary(readr)\nRnD<-read_csv(\"https://www.stats.govt.nz/assets/Uploads/Research-and-development-survey/Research-and-development-survey-2022/Download-data/research-and-development-survey-2022.csv\")\n```\n:::\n\n\n### Парсинг таблиц из Интернета\n\nПожалуй, это самое интересное.\n\nПредположим, мы читаем статью в Википедии, и нам понравились данные, которые там приводятся. Конечно, мы можем скопировать эти данные с помощью мышки, но зачем? Ведь у нас есть R. К тому же результаты такого копирования часто оставляют желать лучшего.\n\nНапример, возьмем страницу в Википедии, посвященную международному индексу счастья.\n\nВпрочем, Вы можете взять любую другую страницу.\n\nДля того, чтобы выгрузить данные непосредственно со страницы, нам понадобится библиотека `rvest`.\n\nЗагрузив библиотеку, создадим объект `content`, в который мы загрузим данные страницы с помощью функции `read_html()`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rvest)\ncontent <- read_html(\"https://ru.wikipedia.org/wiki/%D0%9C%D0%B5%D0%B6%D0%B4%D1%83%D0%BD%D0%B0%D1%80%D0%BE%D0%B4%D0%BD%D1%8B%D0%B9_%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81_%D1%81%D1%87%D0%B0%D1%81%D1%82%D1%8C%D1%8F\")\n```\n:::\n\n\nЕсли рассмотреть этот объект, то можно увидеть, что это список, содержащий содержимое страницы по тэгам - `head` и `body`, в которых что-то хранится в формате xml.\n\nДалее, с помощью функции `html_table` давайте \"вытащим\" таблицы и сохраним их отдельно с именем `tables`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntables <- content %>% html_table(fill = TRUE)\n```\n:::\n\n\nВидим, что таких таблиц 5.\n\nДавайте сохраним первую из них:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable1 <- tables[[3]]\n```\n:::\n\n\nА теперь сохраним ее себе на компьютер с помощью знакомой уже функции `write.xlsx()`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite.xlsx(table1, \"HPI.xlsx\")\n```\n:::\n\n\n## Импорт файла из SPSS (файл .sav)\n\nЭто наш любимый формат, поскольку мы с вами специалисты по социологическим исследованиям, любим SPSS и хотели бы соединить возможности этого пакета с возможностями R.\n\nЧтобы загрузить в R файл в формате `.sav`, мы должны:\n\n-   во-первых, [загрузить файл](https://github.com/domelia/R-book/blob/main/files/%D0%91%D0%B0%D0%B7%D0%B0_%D0%9A%D0%BB%D0%B8%D0%BC%D0%A0%D0%B8%D1%81%D0%BA_2023.sav). Это результаты недавнего исследования кафедры об изменениях климата в высокогорных районах Алтая.\n\n-   во-вторых, нам нужно загрузить библиотеку `haven`, с помощью которой мы можем импортировать данных из формата программы SPSS в R.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(haven)\n```\n:::\n\n\nПосле того, как мы загрузили библиотекy, импортируем базу данных с помощью функции `read_sav`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf<-read_sav(\"База_КлимРиск_2023.sav\", user_na = TRUE) # user_na позволяет активировать настройки, насающиеся пропущенных значений, определяемых пользователем, например, когда значение 99 закодировано как \"затрудняюсь ответить\" и в базе данных оно установлено как пропущенное.\n```\n:::\n\n\nИтак, наши данные теперь сохранены в датафрейме с именем `df`. Мы видим, что в нем есть 202 переменных и 913 наблюдений.\n\n## Самостоятельная работа\n\nУпражнение 1. Используя [портал Открытых данных России](https://data.gov.ru/), найти интересующие Вас данные в разных форматах - excel, csv. Загрузить данные по ссылке, внести в них изменения (создать новую переменную, что-то поменять, используя R) и сохранить новый файл в аналогичном формате.\n\nУпражнение 2. С официального сайта Алтайского края скачать Указ Губернатора о присвоении звания ветерана труда и загрузить его в рабочую папку.\n\nУпражнение 3. С официального сайта Алтайского края, из раздела, посвященного национальной политике, скачать список национально-культурных организаций и сохранить его в формате excel.\n\nУпражнение 4. Загрузить базу данных своего магистерского исследования из SPSS в R.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}